
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PrecioReal ¬∑ Escanea y abre en Amazon</title>
  <meta name="description" content="Escanea EAN/UPC/ISBN, encuentra el ASIN y abre la ficha en Amazon con tu enlace de afiliado.">
  <meta name="theme-color" content="#0b0f14">
  <link rel="manifest" href="/manifest.json">
  <style>
    :root{
      --bg:#0b0f14; --panel:#121824; --text:#e7edf7; --muted:#a8b3c7;
      --brand:#3aa1ff; --brand2:#1e78d5; --bd:#1a2434; --ok:#9fe29f; --bad:#ffb3b3;
      --accent:#2b6cb0; --accent-2:#245b94;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial;
         background:var(--bg); color:var(--text);}
    header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,#0b0f14,#0b0f1400);
           padding:16px 12px 8px;border-bottom:1px solid var(--bd);}
    h1{font-size:1.1rem;margin:0 0 6px 0;letter-spacing:.3px}
    .hint{color:var(--muted);font-size:.9rem}
    main{max-width:900px;margin:0 auto;padding:12px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .btn{appearance:none;border:1px solid var(--bd);background:#182131;color:var(--text);
         padding:10px 12px;border-radius:10px;cursor:pointer}
    .btn.primary{background:linear-gradient(180deg,var(--brand),var(--brand2));border:none;color:#001225;font-weight:600}
    .btn.secondary{background:#162033}
    .btn.warn{background:#3a1c1c;border-color:#6b2a2a}
    .btn:active{transform:translateY(1px)}
    .muted{color:var(--muted)}
    .pill{display:inline-flex;gap:6px;align-items:center;padding:8px 10px;border:1px dashed var(--bd);
          border-radius:999px;color:var(--muted)}
    input[type="text"], input[type="number"]{background:#0f1726;border:1px solid var(--bd);
          color:var(--text);border-radius:10px;padding:10px 12px}
    video{width:100%;max-height:50vh;background:#000;border-radius:12px;border:1px solid var(--bd)}
    .section-title{display:flex;align-items:center;justify-content:space-between;margin:16px 0 8px}
    .cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px}
    .card{background:var(--panel);border:1px solid var(--bd);border-radius:16px;overflow:hidden;display:flex;flex-direction:column}
    .card .cover{aspect-ratio:16/10;background:#0a1220;display:flex;align-items:center;justify-content:center;color:#4a5c7a}
    .card .body{padding:12px;display:flex;flex-direction:column;gap:8px}
    .title{font-weight:600;font-size:.95rem;line-height:1.25rem}
    .cat{font-size:.8rem;color:var(--muted)}
    .row.actions{margin-top:auto}
    .chip{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--bd);padding:4px 8px;border-radius:999px;font-size:.8rem;color:var(--muted)}
    .star{cursor:pointer}
    .price{font-family:ui-monospace,Menlo,Consolas;font-size:.95rem}
    .tabs{display:flex;gap:8px;margin-top:10px}
    .tab{padding:8px 12px;border-radius:12px;border:1px solid var(--bd);cursor:pointer;color:var(--muted)}
    .tab.active{background:#162033;color:var(--text)}
    .divider{height:1px;background:var(--bd);margin:12px 0}
    .counter{font-size:.85rem;color:var(--muted)}
    .flex{display:flex;align-items:center;gap:8px}
    .grow{flex:1}
    footer{padding:40px 12px;color:var(--muted);text-align:center}
    .link{color:#9ecbff;text-decoration:none}
  </style>
</head>
<body>
  <header>
    <h1>PrecioReal ¬∑ Escanea y abre en Amazon</h1>
    <div class="hint">Art√≠culos escaneados y sus precios manuales; podr√°s compararlos en Amazon. Puedes filtrar por tienda con etiquetas. A√±ade a la lista con la ‚≠ê</div>
  </header>

  <main>
    <div class="row">
      <button id="btnScan" class="btn primary">üì∑ Esc√°ner</button>
      <div class="pill">PvP Tienda <input id="inputPrice" type="number" inputmode="decimal" min="0" step="0.01" placeholder="0,00" style="width:110px"></div>
      <input id="inputManual" class="grow" type="text" placeholder="Introducir c√≥digo manual">
      <button id="btnManualGo" class="btn">‚ûï A√±adir</button>
    </div>

    <div class="row toggles" style="margin-top:8px">
      <button class="btn secondary" id="btnToggleSound">Sonido: ON</button>
      <button class="btn secondary" id="btnToggleVibra">Vibraci√≥n: ON</button>
      <button class="btn secondary" id="btnToggleContinuous">Esc√°ner continuo: ON</button>
      <button class="btn secondary" id="btnOpenInApp">Abrir en app: OFF</button>
      <button class="btn secondary" id="btnTorch">Linterna: OFF</button>
      <button class="btn secondary" id="btnTestCam">Test c√°mara</button>
    </div>

    <div style="margin-top:10px">
      <video id="video" playsinline muted></video>
    </div>

    <div class="tabs">
      <div id="tabComparar" class="tab active">Comparar</div>
      <div id="tabLista" class="tab">Lista de la compra</div>
    </div>

    <div id="viewComparar">
      <div class="section-title">
        <div class="flex">
          <span class="counter" id="countComparar">0 √≠tems</span>
        </div>
        <div class="flex">
          <button id="btnClearFilters" class="btn">Limpiar filtros (0)</button>
        </div>
      </div>
      <div class="cards" id="cardsComparar"></div>
    </div>

    <div id="viewLista" style="display:none">
      <div class="section-title">
        <div class="flex">
          <span class="counter" id="countLista">0 √≠tems</span>
        </div>
        <div class="flex">
          <button id="btnMostrarComprados" class="btn">Ver comprados: OFF</button>
        </div>
      </div>
      <div class="cards" id="cardsLista"></div>
    </div>

    <div class="divider"></div>
    <div class="muted">Cumplimiento Amazon Afiliados: no mostramos precios de Amazon; el PvP indicado es manual, introducido por el usuario.</div>
  </main>

  <footer>
    <a class="link" href="/api/zxing.js" target="_blank" rel="noopener">ZXing local</a> ¬∑
    <a class="link" href="/api/lookup?ean=9788491296014" target="_blank" rel="noopener">Lookup test</a> ¬∑
    <a class="link" href="/api/go/B07ZDBT15M?d=9" target="_blank" rel="noopener">Go test</a>
  </footer>

  <!-- ZXing fallback servido por /api/zxing.js -->
  <script src="/api/zxing.js" defer></script>

  <script>
  // ===== Utilidades base =====
  const $ = sel => document.getElementById(sel);
  const sleep = ms => new Promise(r=>setTimeout(r,ms));
  const now = () => Date.now();

  // ===== Settings (localStorage) =====
  function loadSettings(){
    try { return JSON.parse(localStorage.getItem('pr-settings-v1')||'{}'); } catch(e){ return {}; }
  }
  function saveSettings(s){
    localStorage.setItem('pr-settings-v1', JSON.stringify(s||{}));
  }

  let settings = Object.assign(
    { noSound:false, noVibra:false, continuous:true, openInApp:false },
    loadSettings()
  );

  function renderToggles(){
    $('btnToggleSound').textContent = 'Sonido: ' + (settings.noSound ? 'OFF' : 'ON');
    $('btnToggleVibra').textContent = 'Vibraci√≥n: ' + (settings.noVibra ? 'OFF' : 'ON');
    $('btnToggleContinuous').textContent = 'Esc√°ner continuo: ' + (settings.continuous ? 'ON' : 'OFF');
    $('btnOpenInApp').textContent = 'Abrir en app: ' + (settings.openInApp ? 'ON' : 'OFF');
  }
  renderToggles();

  $('btnToggleSound').addEventListener('click', ()=>{ settings.noSound=!settings.noSound; saveSettings(settings); renderToggles(); });
  $('btnToggleVibra').addEventListener('click', ()=>{ settings.noVibra=!settings.noVibra; saveSettings(settings); renderToggles(); });
  $('btnToggleContinuous').addEventListener('click', ()=>{ settings.continuous=!settings.continuous; saveSettings(settings); renderToggles(); });
  $('btnOpenInApp').addEventListener('click', ()=>{ settings.openInApp=!settings.openInApp; saveSettings(settings); renderToggles(); });

  // ===== Estado app =====
  let scanning = false;
  let stream = null;
  let lastScanAt = 0;
  let torchOn = false;
  let detector = ('BarcodeDetector' in window) ? new BarcodeDetector({ formats:['ean_13','ean_8','upc_a','upc_e','code_128'] }) : null;
  let autostopTimer = null;

  // Datos locales
  function loadArr(key){ try{return JSON.parse(localStorage.getItem(key)||'[]')}catch(e){return[]} }
  function saveArr(key, val){ localStorage.setItem(key, JSON.stringify(val||[])); }

  let recientes = loadArr('pr-recent-v1');      // Comparar
  let favoritos = loadArr('pr-favs-v1');        // Lista de la compra
  let showComprados = false;

  function vibrate(ms=40){ try{ if(!settings.noVibra && navigator.vibrate) navigator.vibrate(ms); }catch(e){} }

  // Simple beep
  async function beep(){
    if(settings.noSound) return;
    try{
      const ctx = new (window.AudioContext||window.webkitAudioContext)();
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.connect(g); g.connect(ctx.destination);
      o.type='sine'; o.frequency.value = 880; g.gain.value=0.02;
      o.start();
      setTimeout(()=>{ o.stop(); ctx.close(); },120);
    }catch(e){}
  }

  // ===== Tabs =====
  function switchTab(name){
    const isComparar = name==='comparar';
    $('tabComparar').classList.toggle('active', isComparar);
    $('tabLista').classList.toggle('active', !isComparar);
    $('viewComparar').style.display = isComparar?'block':'none';
    $('viewLista').style.display = isComparar?'none':'block';
    renderAll();
  }
  $('tabComparar').addEventListener('click', ()=>switchTab('comparar'));
  $('tabLista').addEventListener('click', ()=>switchTab('lista'));

  // ===== Render tarjetas =====
  function itemCardHTML(item, inList=false){
    const img = item.image ? `<img src="${item.image}" alt="" style="width:100%;height:100%;object-fit:cover">`
                            : `<div class="cover">Sin imagen</div>`;
    const price = item.userPrice!=null ? `<div class="price">PvP Tienda: ${item.userPrice.toFixed(2)} ‚Ç¨</div>`
                                       : `<div class="price muted">A√±adir precio</div>`;
    const tags = (item.tags||[]).map(t=>`<span class="chip">#${escapeHtml(t)}</span>`).join(' ');
    const star = inList
      ? `<span class="chip">Comprado: <input type="checkbox" ${item.completed?'checked':''} data-action="toggle-comprado" data-id="${item.id}"></span>`
      : `<span class="chip star" title="A√±adir a lista" data-action="fav" data-id="${item.id}">‚≠ê</span>`;

    const btnLabel = inList ? 'Comprar en Amazon' : 'Ver en Amazon';
    return `
    <div class="card" data-id="${item.id}">
      ${img}
      <div class="body">
        <div class="title">${escapeHtml(item.title||'Sin t√≠tulo')}</div>
        <div class="cat">${escapeHtml(item.category||'')}</div>
        ${price}
        <div class="row actions">
          <button class="btn" data-action="open" data-id="${item.id}">üõí ${btnLabel}</button>
          <button class="btn" data-action="add-price" data-id="${item.id}">‚Ç¨ Precio</button>
          ${star}
        </div>
        <div class="row">
          ${tags || ''}
        </div>
      </div>
    </div>`;
  }

  function renderAll(){
    // Comparar
    $('cardsComparar').innerHTML = recientes.map(it=>itemCardHTML(it,false)).join('');
    $('countComparar').textContent = `${recientes.length} √≠tems`;
    // Lista
    const list = favoritos.filter(f=> showComprados ? true : !f.completed);
    $('cardsLista').innerHTML = list.map(it=>itemCardHTML(it,true)).join('');
    $('countLista').textContent = `${list.length} √≠tems`;
  }
  renderAll();

  // Delegaci√≥n de eventos en tarjetas
  document.addEventListener('click', (e)=>{
    const btn = e.target.closest('button,span.star,input[type="checkbox"]');
    if(!btn) return;
    const action = btn.dataset.action;
    const id = btn.dataset.id;
    if(!action || !id) return;

    // Buscar item en ambos arrays
    const item = recientes.find(x=>x.id===id) || favoritos.find(x=>x.id===id);
    if(!item) return;

    if(action==='open'){
      openAmazonSmart(item);
    }
    else if(action==='add-price'){
      const val = prompt('Precio manual (‚Ç¨, usa punto o coma):', item.userPrice!=null? String(item.userPrice):'');
      if(val!=null){
        const n = Number(String(val).replace(',','.'));
        if(!isNaN(n)){
          item.userPrice = Math.round(n*100)/100;
          item.userPriceAt = now();
          persistItem(item);
          renderAll();
        }
      }
    }
    else if(action==='fav'){
      // Mover a favoritos si no est√°
      if(!favoritos.find(x=>x.id===item.id)){
        const copy = {...item, completed:false, completedAt:null};
        favoritos.unshift(copy);
        saveArr('pr-favs-v1', favoritos);
        renderAll();
      }
    }
    else if(action==='toggle-comprado'){
      item.completed = btn.checked;
      item.completedAt = item.completed ? now() : null;
      saveArr('pr-favs-v1', favoritos);
      renderAll();
    }
  });

  $('btnMostrarComprados').addEventListener('click', ()=>{
    showComprados = !showComprados;
    $('btnMostrarComprados').textContent = 'Ver comprados: ' + (showComprados?'ON':'OFF');
    renderAll();
  });

  function persistItem(item){
    // Actualiza en recientes
    const i = recientes.findIndex(x=>x.id===item.id);
    if(i>=0){ recientes[i]=item; saveArr('pr-recent-v1', recientes); }
    // Actualiza en favoritos si existe
    const j = favoritos.findIndex(x=>x.id===item.id);
    if(j>=0){ favoritos[j]=item; saveArr('pr-favs-v1', favoritos); }
  }

  // ===== Esc√°ner =====
  const video = $('video');

  async function startScan(){
    if(scanning) return;
    scanning = true;
    $('btnScan').textContent = '‚õî Detener';
    $('btnScan').classList.add('warn');
    try{
      stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'environment' }, audio:false });
      video.srcObject = stream;
      await video.play();
      scheduleAutostop();

      if(detector){
        scanLoopBarcodeDetector();
      }else{
        // Fallback ZXing (MultiFormatReader)
        scanLoopZXing();
      }
    }catch(e){
      console.error('startScan error', e);
      scanning = false;
      $('btnScan').textContent = 'üì∑ Esc√°ner';
      $('btnScan').classList.remove('warn');
      alert('No se pudo iniciar la c√°mara.');
    }
  }

  function stopScan(){
    scanning = false;
    $('btnScan').textContent = 'üì∑ Esc√°ner';
    $('btnScan').classList.remove('warn');
    try{
      if(stream){
        stream.getTracks().forEach(t=>t.stop());
      }
      stream = null;
    }catch(e){}
    clearAutostop();
    torchOff();
  }

  $('btnScan').addEventListener('click', ()=> scanning ? stopScan() : startScan() );

  function scheduleAutostop(){
    clearAutostop();
    autostopTimer = setTimeout(()=>{
      if(scanning) stopScan();
    }, 10*60*1000); // 10 minutos
  }
  function clearAutostop(){ if(autostopTimer){ clearTimeout(autostopTimer); autostopTimer=null; }}

  async function scanLoopBarcodeDetector(){
    while(scanning){
      try{
        const barcodes = await detector.detect(video);
        if(barcodes && barcodes.length){
          const code = sanitizeCode(barcodes[0].rawValue || '');
          if(code) await onCodeDetected(code);
        }
      }catch(e){ /* ignore */ }
      await sleep(120);
    }
  }

  // ZXing fallback
  async function scanLoopZXing(){
    // Espera a que ZXing est√© cargado
    let ZX = window.ZXing || window['ZXing'];
    for(let i=0;i<50 && !ZX;i++){ await sleep(100); ZX = window.ZXing || window['ZXing']; }
    if(!ZX){ console.error('ZXing no disponible'); return; }
    const reader = new ZX.BrowserMultiFormatReader();
    try{
      await reader.decodeFromVideoDevice(null, video, async (result, err)=>{
        if(!scanning) return;
        if(result){
          const code = sanitizeCode(result.getText());
          if(code) await onCodeDetected(code);
          if(!settings.continuous){
            reader.reset();
          }
        }
      });
    }catch(e){ console.error('ZXing error', e); }
  }

  function sanitizeCode(raw){
    if(!raw) return '';
    return String(raw).replace(/[^0-9Xx]/g,'').toUpperCase();
  }

  async function onCodeDetected(code){
    const minBetween = 700;
    const t = now();
    if(t - lastScanAt < minBetween) return; // anti-bounce
    lastScanAt = t;
    scheduleAutostop();

    vibrate(30); beep();

    let item = await resolveEAN(code);
    if(item){
      // A√±ade/actualiza en recientes
      const existing = recientes.find(x=>x.id===item.id);
      if(!existing){ recientes.unshift(item); saveArr('pr-recent-v1', recientes); }
      else { Object.assign(existing, item); saveArr('pr-recent-v1', recientes); }
      renderAll();
      if(!settings.continuous) stopScan();
    }
  }

  // ===== Lookup EAN -> ASIN (con cache y cola offline) =====
  async function resolveEAN(ean){
    const cacheKey = 'pr-cache-' + ean;
    try{
      const cached = JSON.parse(localStorage.getItem(cacheKey)||'null');
      if(cached && (now()-cached.t) < 30*60*1000){
        return cached.item;
      }
    }catch(e){}

    try{
      const r = await fetch('/api/lookup?ean='+encodeURIComponent(ean), { cache:'no-store' });
      if(!r.ok) throw new Error('lookup http '+r.status);
      const data = await r.json();
      if(!data.success) throw new Error('lookup no success');
      const prod = data.product||{};
      const meta = data.meta||{};
      const asin = meta.asin || '';
      const domain = meta.domain || '9';

      const item = {
        id: asin || ean,
        ean,
        asin,
        domain,
        title: prod.title || ('EAN ' + ean),
        image: prod.image || null,
        category: prod.category || '',
        affiliateLink: prod.affiliateLink || ('/api/go/'+encodeURIComponent(asin)+'?d='+encodeURIComponent(domain)),
        userPrice: null,
        userPriceAt: null,
        tags: [],
        completed: false,
        completedAt: null,
        ts: now()
      };
      localStorage.setItem(cacheKey, JSON.stringify({ t:now(), item }));
      return item;
    }catch(err){
      console.warn('lookup fall√≥, encolando', err);
      enqueueOffline(ean);
      return null;
    }
  }

  function enqueueOffline(ean){
    const q = loadArr('pr-queue-v1');
    q.push({ ean, t: now() });
    saveArr('pr-queue-v1', q);
  }

  async function reprocesarCola(){
    const q = loadArr('pr-queue-v1');
    if(!q.length) return;
    const next = q.shift();
    saveArr('pr-queue-v1', q);
    const item = await resolveEAN(next.ean);
    if(item){
      if(!recientes.find(x=>x.id===item.id)){
        recientes.unshift(item); saveArr('pr-recent-v1', recientes); renderAll();
      }
    }
    // sigue con m√°s en background suave
    setTimeout(reprocesarCola, 500);
  }
  window.addEventListener('online', reprocesarCola);
  reprocesarCola();

  // ===== Manual input =====
  $('btnManualGo').addEventListener('click', async ()=>{
    const code = sanitizeCode($('inputManual').value);
    if(!code) return;
    const item = await resolveEAN(code);
    if(item){
      if(!recientes.find(x=>x.id===item.id)){
        recientes.unshift(item); saveArr('pr-recent-v1', recientes); renderAll();
      }
    }
  });

  // ===== Linterna =====
  $('btnTorch').addEventListener('click', async ()=>{
    if(!stream){ alert('Inicia el esc√°ner primero.'); return; }
    const track = stream.getVideoTracks()[0];
    const caps = track.getCapabilities?.();
    if(!caps || !('torch' in caps)){ alert('Este dispositivo/navegador no soporta linterna.'); return; }
    torchOn = !torchOn;
    try{
      await track.applyConstraints({ advanced:[{ torch: torchOn }] });
      $('btnTorch').textContent = 'Linterna: ' + (torchOn?'ON':'OFF');
    }catch(e){
      alert('No se pudo activar la linterna.');
    }
  });

  $('btnTestCam').addEventListener('click', async ()=>{
    try{
      const s = await navigator.mediaDevices.getUserMedia({ video:true, audio:false });
      s.getTracks().forEach(t=>t.stop());
      alert('C√°mara OK');
    }catch(e){ alert('Error c√°mara'); }
  });

  // ===== Amazon deep-link con app preferente y fallback web =====
  function isAndroidIntentCapable(){
    const ua = navigator.userAgent || '';
    return /Android/i.test(ua) && /(Chrome|EdgA|Brave|SamsungBrowser|Chromium)/i.test(ua);
  }
  function tldFromKeepa(domainIdx){
    const map = {1:'com',2:'co.uk',3:'de',4:'fr',5:'co.jp',6:'ca',7:'cn',8:'it',9:'es',10:'in',11:'com.mx',12:'com.br',13:'com.au',14:'nl',15:'se',16:'pl',17:'com.tr',18:'sg',19:'sa',20:'ae'};
    return map[String(domainIdx||9)] || 'es';
  }

  function openAmazonSmart(item){
    try{
      const webHref = item?.affiliateLink
        ? new URL(item.affiliateLink, location.origin).href
        : `https://www.amazon.${tldFromKeepa(item?.domain)}/dp/${encodeURIComponent(item?.asin || '')}`;

      if (settings.openInApp && isAndroidIntentCapable() && (item?.asin)){
        const tld = tldFromKeepa(item?.domain);
        const asin = item.asin;
        const intentUrl =
          `intent://www.amazon.${tld}/dp/${encodeURIComponent(asin)}#Intent;`+
          `scheme=https;package=com.amazon.mShop.android.shopping;`+
          `S.browser_fallback_url=${encodeURIComponent(webHref)};end`;
        location.href = intentUrl;
        return;
      }
      location.href = webHref;
    }catch(e){ console.error('[openAmazonSmart] error', e); }
  }

  // ===== Helpers =====
  function escapeHtml(s){
    return String(s||'').replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
  }

  // ===== PWA: registra SW si existe =====
  if('serviceWorker' in navigator){
    navigator.serviceWorker.register('/sw.js').catch(()=>{});
  }
  </script>
</body>
</html>
