<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PrecioReal ¬∑ Escanea y abre en Amazon</title>
  <meta name="description" content="Escanea EAN/UPC/ISBN, encuentra el ASIN y abre la ficha en Amazon con tu enlace de afiliado.">
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#0b0f14">
  <style>
    :root{ --bg:#0b0f14; --panel:#121824; --text:#e7edf7; --muted:#a8b3c7; --brand:#3aa1ff; --brand2:#1e78d5; --bd:#1a2434; --ok:#9fe29f; --bad:#ffb3b3; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:820px;margin:0 auto;padding:16px}
    header{display:flex;align-items:center;gap:12px;padding:16px 0;border-bottom:1px solid var(--bd)}
    .logo{width:40px;height:40px;border-radius:10px;display:grid;place-items:center;background:linear-gradient(135deg,var(--brand),#7cc8ff);color:#041423;font-weight:900}
    h1{font-size:18px;margin:0}.muted{color:var(--muted)}
    .panel{background:var(--panel);border:1px solid var(--bd);border-radius:14px;padding:14px;margin:16px 0}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:12px 16px;border:0;border-radius:12px;cursor:pointer;background:linear-gradient(180deg,var(--brand),var(--brand2));color:#06121f;font-weight:800}
    .btn.secondary{background:#182339;color:var(--text);border:1px solid #223352}
    .btn.ghost{background:transparent;border:1px dashed #2a3a5a;color:#9bb4d9}
    .btn[disabled]{opacity:.5;cursor:not-allowed}
    .btn.danger{background:linear-gradient(180deg,#ff6464,#cc3030);color:#210000}
    .row{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
    .row input{flex:1;min-width:180px;padding:12px;border-radius:12px;border:1px solid #223352;background:#0c1322;color:#e7edf7}
    #scanner{position:relative;aspect-ratio:3/2;background:#0d1423;border:1px dashed #223352;border-radius:12px;display:grid;place-items:center;overflow:hidden;margin-top:12px}
    #scanner video{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
    #overlay{position:absolute;left:8px;right:8px;bottom:8px;background:rgba(0,0,0,.45);border:1px solid #223352;border-radius:8px;padding:6px 8px;font-size:12px;color:#cfe7ff;white-space:pre-line}
    .hint{font-size:12px;color:#9bb4d9;margin-top:6px}
    footer{margin:18px 0 8px;border-top:1px solid var(--bd);padding-top:12px;color:#a8b3c7;font-size:0.9rem;line-height:1.35}
    .bar{display:flex;justify-content:space-between;align-items:center;margin:8px 0 4px 0}
    .bar .title{font-size:18px;font-weight:900}
    .list-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:10px}
    .mini{position:relative;display:grid;grid-template-columns:72px 1fr;gap:10px;align-items:center;background:#0d1423;border:1px solid var(--bd);border-radius:10px;padding:10px}
    .mini .thumb{width:72px;height:72px;border-radius:8px;background:#101a2c;display:grid;place-items:center;overflow:hidden}
    .mini .thumb img{width:100%;height:100%;object-fit:cover}
    .mini .title{font-size:16px;font-weight:800;line-height:1.25;max-height:2.6em;overflow:hidden}
    .mini .muted{font-size:12px}
    .mini .actions{display:flex;gap:6px;margin-top:12px;flex-wrap:wrap}
    .banner{display:flex;justify-content:center;align-items:center;width:100%;padding:12px 14px;border-radius:10px;background:#182339;border:1px solid #223352;color:#e7edf7;text-decoration:none;font-size:15px;font-weight:900;min-height:48px}
    .pvpLineMini{font-size:14px;font-weight:800;margin-top:8px;color:#cfe2ff;text-align:right}
    .badgeManual{display:inline-block;margin-right:6px;padding:2px 6px;border-radius:999px;border:1px solid #2a3f66;background:#13203b;color:#cfe2ff;font-size:11px;font-weight:700;vertical-align:baseline}
    .pvpSub{font-size:11px;color:#9bb4d9;margin-top:4px;text-align:right;font-weight:500}
    .icon-btn{position:absolute;top:6px;left:6px;background:#172033;border:1px solid #284066;color:#c9d9f2;width:24px;height:24px;line-height:22px;text-align:center;border-radius:8px;cursor:pointer;font-weight:900}
    .star{position:absolute;top:6px;right:6px;background:#172033;border:1px solid #284066;color:#f6e08f;width:36px;height:36px;line-height:34px;text-align:center;border-radius:12px;cursor:pointer;font-weight:900;font-size:20px}
    .star.off{color:#b0b0b0}
    .empty{color:#a8b3c7;font-size:13px}
    .toggles{display:flex;gap:8px;flex-wrap:wrap}

    /* PvP input pill + plus */
    .pvpRow{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:10px}
    .pill{display:flex;align-items:center;gap:8px;padding:10px 12px;border-radius:12px;border:1px solid #223352;background:#0c1322;color:#e7edf7;cursor:pointer;font-weight:800}
    .pill .hintSmall{font-size:12px;color:#9bb4d9;font-weight:600}
    .btn.plus{width:44px;height:44px;display:inline-grid;place-items:center;font-size:22px;padding:0;border-radius:12px}

    /* Drawer */
    #drawer{display:none;margin-top:10px}
    #drawer.open{display:block}
    .drawerBox{border:1px solid #223352;background:#0d1423;border-radius:12px;padding:12px}
    .drawerGrid{display:grid;grid-template-columns:1fr;gap:12px}
    @media (min-width:640px){ .drawerGrid{grid-template-columns:1fr 1fr;} }

    /* Keypad modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:9999}
    .card{background:#0d1423;border:1px solid #1a2434;border-radius:12px;padding:12px;width:min(420px,92vw)}
    .kDisplay{display:flex;justify-content:space-between;align-items:center;border:1px solid #223352;background:#0c1322;color:#e7edf7;border-radius:10px;padding:10px 12px;font-size:20px;font-weight:900}
    .kGrid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:10px}
    .kBtn{padding:14px 0;border:1px solid #223352;background:#162338;color:#e7edf7;border-radius:10px;font-size:18px;font-weight:900;cursor:pointer}
    .kRow{display:flex;gap:8px;margin-top:10px}
    .kBtn.ok{background:linear-gradient(180deg,var(--brand),var(--brand2));color:#06121f;flex:1}
    .kBtn.del{background:#2a1a1a}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo">PR</div>
      <div>
        <h1>PrecioReal</h1>
        <div class="muted">Escanea un producto y abre su ficha en Amazon</div>
      </div>
    </header>

    <section class="panel">
      <b>Escanear con la c√°mara</b>
      <div id="scanner"><div id="overlay">Pulsa ‚ÄúEscanear‚Äù y permite la c√°mara</div></div>
      <div class="row">
        <button class="btn" id="btnScan">Escanear</button>
        <!-- PvP pill + plus -->
        <div class="pvpRow">
          <div class="pill" id="pvpPill" title="Introduce tu precio (solo local)">
            <span>PvP Tienda</span>
            <span id="pvpValue" class="hintSmall">‚Äî</span>
          </div>
          <button class="btn secondary plus" id="btnMore" title="M√°s opciones">+</button>
        </div>
        <!-- (Linterna / Test se mueven al drawer) -->
        <button class="btn secondary" id="btnInstall" style="display:none">Instalar app</button>
      </div>

      <!-- Drawer (opciones + manual + utilidades) -->
      <div id="drawer" class="drawerBox">
        <div class="drawerGrid">
          <div>
            <b>Opciones</b>
            <div class="row toggles" style="margin-top:8px">
              <button class="btn secondary" id="btnToggleSound">Sonido: OFF</button>
              <button class="btn secondary" id="btnToggleVibra">Vibraci√≥n: ON</button>
              <button class="btn secondary" id="btnToggleContinuous">Esc√°ner continuo: ON</button>
            </div>
            <div class="row" style="margin-top:8px">
              <button class="btn secondary" id="btnTorch" title="Activar/desactivar linterna">Linterna</button>
              <button class="btn secondary" id="btnTest">Test c√°mara</button>
            </div>
          </div>
          <div>
            <b>C√≥digo manual</b>
            <div class="row" style="margin-top:8px">
              <input id="eanInput" inputmode="numeric" pattern="[0-9]*" placeholder="Ej.: 9788491296014" />
              <button class="btn secondary" id="btnBuscar">Buscar</button>
            </div>
            <div class="hint" id="eanHint"></div>
          </div>
        </div>
      </div>

      <div class="hint">Consejo: apoya el m√≥vil y apunta al c√≥digo de barras.</div>
    </section>

    <!-- √öltimos escaneados -->
    <section class="panel" id="panelRecents">
      <div class="bar">
        <div class="title">üïò √öltimos escaneados</div>
        <button class="btn ghost" id="btnClearRecents">Vaciar lista</button>
      </div>
      <div id="recents" class="list-grid"></div>
      <div id="recentsEmpty" class="empty" style="display:none">Aqu√≠ ver√°s tus √∫ltimos escaneos.</div>
      <div id="tipRecents" class="empty" style="margin-top:10px">Consejo: A√±√°delo en tu carrito de Amazon para no perderlo.</div>
    </section>

    <!-- Favoritos -->
    <section class="panel" id="panelFavs">
      <div class="bar">
        <div class="title" id="favTitle">Favoritos (0)</div>
        <button class="btn ghost" id="btnClearFavs">Vaciar favoritos</button>
      </div>
      <div id="favs" class="list-grid"></div>
      <div id="favsEmpty" class="empty" style="display:none">‚≠ê A√±ade los productos que quieras guardar.</div>
    </section>

    <footer>
      En calidad de Afiliado de Amazon, obtengo ingresos por las compras adscritas que cumplen los requisitos aplicables.
    </footer>
  </div>

  <script>
  (function(){
    'use strict';

    const $ = id => document.getElementById(id);
    const note = (m)=>{ const o=$('overlay'); if(o){o.textContent=m;o.style.display='block';} console.log('[PrecioReal]', m); };
    const hideNote = ()=>{ const o=$('overlay'); if(o) o.style.display='none'; };
    const ttlSec = 1800;
    const MAX_RECENTS = 20;
    const K_RECENTS = 'pr-recent-v1';
    const K_FAVS = 'pr-favs-v1';
    const K_SETTINGS = 'pr-settings-v1';

    function loadSettings(){ try{ return JSON.parse(localStorage.getItem(K_SETTINGS)||'{}')||{}; }catch(_){ return {}; } }
    function saveSettings(s){ try{ localStorage.setItem(K_SETTINGS, JSON.stringify(s)); }catch(_){ } }

    // Sonido OFF por defecto
    let settings = Object.assign({ noSound:true, noVibra:false, continuous:true }, loadSettings());

    function renderToggles(){
      $('btnToggleSound').textContent = 'Sonido: ' + (settings.noSound ? 'OFF' : 'ON');
      $('btnToggleVibra').textContent = 'Vibraci√≥n: ' + (settings.noVibra ? 'OFF' : 'ON');
      $('btnToggleContinuous').textContent = 'Esc√°ner continuo: ' + (settings.continuous ? 'ON' : 'OFF');
    }

    function beep(){
      try{
        if (!settings.noSound){
          const ctx=new (window.AudioContext||window.webkitAudioContext)();
          const o=ctx.createOscillator(); const g=ctx.createGain();
          o.frequency.value=880; g.gain.value=0.1; o.connect(g).connect(ctx.destination);
          o.start(); setTimeout(()=>{o.stop();ctx.close();},120);
        }
      }catch(_){}
      try{ if (!settings.noVibra){ navigator.vibrate && navigator.vibrate(80); } }catch(_){}
    }
    const fmtMoney = (n)=> (isFinite(n)? (Number(n).toFixed(2).replace('.',',')) : '');

    function ean13Valid(s){ s=String(s).replace(/[^0-9]/g,''); if(s.length!==13) return false; const d=s.split('').map(n=>+n); const c=d[12]; let sum=0; for(let i=0;i<12;i++) sum+=d[i]*(i%2===0?1:3); return ((10-(sum%10))%10)===c; }
    function ean8Valid(s){ s=String(s).replace(/[^0-9]/g,''); if(s.length!==8) return false; const d=s.split('').map(n=>+n); const c=d[7]; let sum=0; for(let i=0;i<7;i++) sum+=d[i]*(i%2===0?3:1); return ((10-(sum%10))%10)===c; }
    function upcAValid(s){ s=String(s).replace(/[^0-9]/g,''); if(s.length!==12) return false; return ean13Valid('0'+s); }
    function validCode(code){ const s=String(code).replace(/[^0-9]/g,''); if(s.length===13) return {ok:ean13Valid(s),type:'EAN-13'}; if(s.length===8) return {ok:ean8Valid(s),type:'EAN-8'}; if(s.length===12) return {ok:upcAValid(s),type:'UPC-A'}; return {ok:false,type:'unknown'}; }
    function setEanHint(msg, ok){ const el=$('eanHint'); el.textContent=msg||''; el.style.color=ok?'#9fe29f':'#ffb3b3'; }

    function cacheGet(ean){ try{ const raw=localStorage.getItem('pr-cache-'+ean); if(!raw) return null; const o=JSON.parse(raw); if(!o||!o.t||!o.d) return null; if((Date.now()-o.t)/1000>ttlSec) return null; return o.d; }catch(_){ return null; } }
    function cacheSet(ean,data){ try{ localStorage.setItem('pr-cache-'+ean, JSON.stringify({t:Date.now(),d:data})); }catch(_){ } }

    function loadList(key){ try{ return JSON.parse(localStorage.getItem(key)||'[]')||[]; }catch(_){ return []; } }
    function saveList(key,arr){ try{ localStorage.setItem(key, JSON.stringify(arr)); }catch(_){ } }
    function getFromAnyList(id){ const a=loadList(K_RECENTS).find(x=>x.id===id); if(a) return a; return loadList(K_FAVS).find(x=>x.id===id)||null; }

    function normalizeTags(arr){
      if(!Array.isArray(arr)) return [];
      const out=[]; for(const t of arr){
        const s=String(t||'').trim();
        if(!s) continue;
        if(!out.includes(s)) out.push(s);
      }
      return out.slice(0,12);
    }
    function colorForTag(tag){
      const s = String(tag||'');
      let h=0; for(let i=0;i<s.length;i++){ h = (h*31 + s.charCodeAt(i)) % 360; }
      const bg = `hsla(${h},70%,18%,.55)`;
      const br = `hsla(${h},70%,38%,.95)`;
      const tx = `hsla(${h},95%,90%,1)`;
      return { bg, br, tx };
    }

    function normalizeItem(ean, resp){
      const p = resp?.product||{}; const m = resp?.meta||{};
      const id = m.asin || ean || p.asin || p.id || (p.affiliateLink||'').split('/api/go/')[1]?.split('?')[0] || null;
      const prev = getFromAnyList(id) || {};
      return { id, ean: ean||null, asin: m.asin||null, domain: m.domain||null,
               title: p.title||('C√≥digo '+(ean||'desconocido')), image: p.image||null,
               category: p.category||'', affiliateLink: p.affiliateLink||null,
               userPrice: prev.userPrice||null, userPriceAt: prev.userPriceAt||null,
               tags: normalizeTags(prev.tags || p.tags || []),
               ts: Date.now() };
    }

    function addRecent(item){
      if(!item||!item.id) return;
      const arr=loadList(K_RECENTS); const idx=arr.findIndex(x=>x.id===item.id);
      if(idx>=0) arr.splice(idx,1);
      arr.unshift(item); if(arr.length>MAX_RECENTS) arr.length=MAX_RECENTS;
      saveList(K_RECENTS, arr); renderRecents();
    }

    function updateItemPvp(id, pvp){
      const apply=(key)=>{ const arr=loadList(key); const i=arr.findIndex(x=>x.id===id);
        if(i>=0){ arr[i].userPrice=pvp; arr[i].userPriceAt=(pvp!=null)?Date.now():null; saveList(key,arr); } };
      apply(K_RECENTS); apply(K_FAVS);
      renderRecents(); renderFavs();
    }

    function addTagTo(id, tag){
      const t = String(tag||'').trim(); if(!t) return;
      const apply=(key)=>{ const arr=loadList(key); const i=arr.findIndex(x=>x.id===id);
        if(i>=0){ const tags=normalizeTags(arr[i].tags||[]); if(!tags.includes(t)) tags.push(t); arr[i].tags=tags; saveList(key,arr); } };
      apply(K_RECENTS); apply(K_FAVS);
      renderRecents(); renderFavs();
    }
    function removeTagFrom(id, tag){
      const t = String(tag||'').trim(); if(!t) return;
      const apply=(key)=>{ const arr=loadList(key); const i=arr.findIndex(x=>x.id===id);
        if(i>=0){ const tags=normalizeTags(arr[i].tags||[]).filter(x=>x!==t); arr[i].tags=tags; saveList(key,arr); } };
      apply(K_RECENTS); apply(K_FAVS);
      renderRecents(); renderFavs();
    }

    function removeRecent(id){ const arr=loadList(K_RECENTS).filter(x=>x.id!==id); saveList(K_RECENTS,arr); renderRecents(); }
    function clearRecents(){ saveList(K_RECENTS,[]); renderRecents(); }

    function extractASIN(link){
      if (!link) return null;
      const m = String(link).match(/\/(?:dp|gp\/product)\/([A-Z0-9]{10})/i);
      return m ? m[1].toUpperCase() : null;
    }
    function buildWebLink(item){
      const domain = item?.domain || 'amazon.es';
      const asin = item?.asin || extractASIN(item?.affiliateLink) || '';
      return item?.affiliateLink || `https://www.${domain}/dp/${asin}`;
    }
    function isAndroidChrome(){
      const ua = navigator.userAgent || '';
      return /Android/i.test(ua) && /(Chrome|EdgA|Chromium|SamsungBrowser|Brave)/i.test(ua);
    }
    function openAmazon(item){
      const web = buildWebLink(item);
      const asin = item.asin || extractASIN(web);
      if (isAndroidChrome() && asin){
        const pathAndQuery = web.replace(/^https?:\/\//i, '');
        const appIntent =
          `intent://${pathAndQuery}` +
          `#Intent;scheme=https;package=com.amazon.mShop.android.shopping;` +
          `S.browser_fallback_url=${encodeURIComponent(web)};end`;
        let jumped = false;
        setTimeout(()=>{ if(!jumped) location.href = web; }, 1500);
        try { location.href = appIntent; jumped = true; } catch(_) { location.href = web; }
        return;
      }
      location.href = web;
    }

    function renderList(containerId, emptyId, arr, source){
      const el=$(containerId), empty=$(emptyId);
      if(!arr.length){ el.innerHTML=''; empty.style.display='block'; return; }
      empty.style.display='none';
      el.innerHTML = arr.map(item=>{
        const safeTitle=(item.title||'Producto').replace(/</g,'&lt;');
        const img=item.image?`<img alt="Imagen" src="${item.image}">`:'‚Äî';
        const starOn=isFav(item.id);
        const disabled=item.affiliateLink?'':'disabled';

        const pvpBlock = (item.userPrice!=null) ? `
          <div class="pvpLineMini" data-action="price" title="Toca para editar">
            <span class="badgeManual">Manual</span> üè∑Ô∏è Precio anotado: ${fmtMoney(item.userPrice)} ‚Ç¨
            <div class="pvpSub">Solo en este dispositivo ¬∑ No es el precio de Amazon.</div>
          </div>` : '';

        let tagsBlock = '';
        if (source==='fav'){
          const tags = normalizeTags(item.tags||[]);
          const chips = tags.map(t=>{
            const c = colorForTag(t);
            const style = `background:${c.bg};border-color:${c.br};color:${c.tx}`;
            return `<span class="chip" data-action="tag-remove" data-tag="${t}" style="${style}" title="Quitar etiqueta">${t}<span class="x">√ó</span></span>`;
          }).join('');
          tagsBlock = `
            <div class="tags" data-id="${item.id}">
              ${chips}
              <span class="chip add" data-action="tag-add">+ etiqueta</span>
            </div>`;
        }

        return `
          <div class="mini" data-id="${item.id}">
            <div class="icon-btn" title="Quitar" data-action="remove">‚úï</div>
            <div class="star ${starOn?'':'off'}" title="${starOn?'Quitar de favoritos':'A√±adir a favoritos'}" data-action="star">‚òÖ</div>
            <div class="thumb">${img}</div>
            <div>
              <div class="title">${safeTitle}</div>
              <div class="muted">${item.category||'‚Äî'}</div>
              <div class="actions" style="margin-top:14px">
                <a class="banner ${disabled}" href="${item.affiliateLink||'#'}" data-action="open">üõí Ver en Amazon</a>
              </div>
              ${pvpBlock}
              ${tagsBlock}
            </div>
          </div>`;
      }).join('');

      el.querySelectorAll('.mini').forEach(card=>{
        const id=card.getAttribute('data-id');
        const item=arr.find(x=>x.id===id);
        card.addEventListener('click', (ev)=>{
          const act=ev.target?.getAttribute?.('data-action'); 
          if(!act) return;
          ev.preventDefault(); ev.stopPropagation();
          if(act==='remove'){ source==='recents'?removeRecent(id):(saveList(K_FAVS,loadList(K_FAVS).filter(x=>x.id!==id)),renderFavs(),renderRecents()); }
          if(act==='star'){ toggleFav(item); }
          if(act==='open'){ openAmazon(item); }
          if(act==='price'){ askAndSavePvp(id); }
          if(act==='tag-add'){
            const t = prompt('Nueva etiqueta (ej.: supermercado, regalo, urgente):','');
            if(t!=null){ addTagTo(id, t); }
          }
          if(act==='tag-remove'){
            const t = ev.target?.getAttribute?.('data-tag') || ev.target?.parentElement?.getAttribute?.('data-tag');
            if(!t) return;
            if(confirm(`Quitar etiqueta ‚Äú${t}‚Äù?`)){ removeTagFrom(id, t); }
          }
        }, { passive:false });
      });
    }

    function renderRecents(){ renderList('recents','recentsEmpty', loadList(K_RECENTS), 'recent'); }
    function renderFavs(){ const arr=loadList(K_FAVS); renderList('favs','favsEmpty', arr, 'fav'); const t=$('favTitle'); if(t) t.textContent='Favoritos ('+arr.length+')'; }

    function renderResult(ok, p, ean, meta){
      if(!ok){ note('No encontrado para '+ean); return; }
      const item = normalizeItem(ean, { product:p, meta:meta||{} });
      addRecent(item);
      note('A√±adido a ‚Äú√öltimos escaneados‚Äù.'); setTimeout(hideNote, 900);
      updatePvpPillText();
    }

    // ---------- C√°mara / Esc√°ner ----------
    let currentStream=null, torchOn=false, scannerReader=null;

    function stopScanner(){
      try{ scannerReader && scannerReader.reset && scannerReader.reset(); }catch(_){}
      try{ currentStream && currentStream.getTracks().forEach(t=>t.stop()); }catch(_){}
      currentStream=null; scannerReader=null; torchOn=false;
      note('Esc√°ner detenido'); setTimeout(hideNote, 800);
    }
    function ensureMedia(){ return !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia); }

    async function pickBackCameraDeviceId(){
      try{
        const devs = await navigator.mediaDevices.enumerateDevices();
        const cams = devs.filter(d=>d.kind==='videoinput');
        const back = cams.find(d=>/back|rear|environment/i.test(d.label)) || cams[1] || cams[0];
        return back && back.deviceId ? back.deviceId : null;
      }catch{ return null; }
    }

    async function runBarcodeDetectorLoop(video, onCode) {
      if (!('BarcodeDetector' in window)) return false;
      const det = new BarcodeDetector({
        formats: ['ean_13','ean_8','upc_a','upc_e','code_128','code_39','qr_code']
      });
      let stop = false;
      const tick = async () => {
        if (stop) return;
        try {
          const codes = await det.detect(video);
          if (codes && codes.length) {
            const code = String(codes[0].rawValue || '').replace(/[^0-9Xx]/g, '');
            if (code) onCode(code);
          }
        } catch {}
        if ('requestVideoFrameCallback' in video) {
          video.requestVideoFrameCallback(tick);
        } else {
          setTimeout(tick, 80);
        }
      };
      tick();
      return () => { stop = true; };
    }

    function loadZXing(){
      if (window.ZXingBrowser || window.ZXing) return Promise.resolve(true);
      return new Promise(resolve=>{
        const s=document.createElement('script');
        s.src='/api/zxing.js'; s.async=true;
        s.onload=()=>resolve(!!(window.ZXingBrowser||window.ZXing));
        s.onerror=()=>resolve(false);
        document.head.appendChild(s);
      });
    }

    async function toggleTorch(){
      const track=currentStream?.getVideoTracks?.()[0];
      const caps=track?.getCapabilities?.();
      if(!track || !caps || !caps.torch){ note('Este dispositivo/navegador no permite linterna en c√°mara.'); return; }
      try{
        torchOn=!torchOn;
        await track.applyConstraints({ advanced:[{ torch:torchOn }] });
        note(torchOn?'Linterna: ON':'Linterna: OFF'); setTimeout(hideNote, 800);
      }catch(_){ note('No se pudo cambiar la linterna.'); }
    }

    function setScanButtonActive(active){
      const btn = $('btnScan');
      if (!btn) return;
      if (active){
        btn.textContent = 'Detener';
        btn.classList.add('danger');
      }else{
        btn.textContent = 'Escanear';
        btn.classList.remove('danger');
      }
    }

    async function startScanner(){
      if(!ensureMedia()){ note('Este navegador no soporta c√°mara.'); return; }

      // Pre-permiso
      note('Pidiendo permiso de c√°mara‚Ä¶');
      try{
        const preId = await pickBackCameraDeviceId();
        const preConstraints = preId ? { video:{ deviceId:{ exact:preId } }, audio:false }
                                     : { video:{ facingMode:{ ideal:'environment' } }, audio:false };
        const prov = await navigator.mediaDevices.getUserMedia(preConstraints);
        prov.getTracks().forEach(t=>t.stop());
      }catch(e){
        if(e && (e.name==='NotAllowedError'||e.name==='PermissionDeniedError')){ note('Permiso denegado. Act√≠valo en los ajustes del navegador.'); return; }
        if(e && (e.name==='NotFoundError'||e.name==='DevicesNotFoundError')){ note('No hay c√°mara disponible.'); return; }
      }

      const cont=$('scanner');
      const video=document.createElement('video');
      video.setAttribute('playsinline',''); video.setAttribute('autoplay',''); video.setAttribute('muted','');
      video.muted=true; video.playsInline=true;
      video.style.width='100%'; video.style.height='100%'; video.style.objectFit='cover';
      cont.replaceChildren(video, (function(){ const m=document.createElement('div'); m.id='overlay'; m.textContent='Apunta al c√≥digo de barras ¬∑ Mant√©n el m√≥vil estable'; return m;})());

      // Stream real (intentando trasera)
      note('Abriendo c√°mara‚Ä¶');
      try{
        const backId = await pickBackCameraDeviceId();
        const videoConstraints = backId ? { deviceId:{ exact: backId } }
                                        : { facingMode:{ ideal:'environment' } };
        currentStream = await navigator.mediaDevices.getUserMedia({ video: videoConstraints, audio:false });
        video.srcObject=currentStream;
        await video.play().catch(()=>{});
        hideNote();
      }catch(e){
        note('No se pudo abrir la c√°mara.'); return;
      }

      // Estado del bot√≥n linterna
      try{
        const torchBtn = $('btnTorch');
        const track = currentStream?.getVideoTracks?.()[0];
        const caps = track?.getCapabilities?.();
        const hasTorch = !!(caps && caps.torch);
        if (torchBtn){
          torchBtn.disabled = !hasTorch;
          torchBtn.title = hasTorch ? 'Activar/desactivar linterna' : 'No disponible en este dispositivo/navegador';
        }
      }catch{}

      // Gesti√≥n com√∫n de resultados
      let justScanned=false, lastText='', lastAt=0;
      const COOLDOWN=1200;
      const onScan = (raw) => {
        const code = String(raw||'').replace(/[^0-9Xx]/g,'');
        if (!code) return;
        const now = Date.now();
        if (settings.continuous) {
          if (code===lastText && (now-lastAt)<COOLDOWN) return;
          lastText=code; lastAt=now; beep(); lookupAndRender(code);
        } else {
          if (!justScanned) { justScanned=true; beep(); stopScanner(); setScanButtonActive(false); lookupAndRender(code); }
        }
      };

      // 1) BarcodeDetector
      let stopBD = null;
      if ('BarcodeDetector' in window){
        try {
          stopBD = await runBarcodeDetectorLoop(video, onScan);
          if (stopBD) {
            console.log('[PrecioReal] Usando BarcodeDetector');
            scannerReader = { reset: ()=>{ try{ stopBD(); }catch{} } };
            setScanButtonActive(true);
            return;
          }
        } catch {}
      }

      // 2) ZXing fallback
      note('Cargando motor ZXing‚Ä¶');
      const ok = await loadZXing();
      const ZX = window.ZXingBrowser || window.ZXing || null;
      const ReaderCtor = ZX && ZX.BrowserMultiFormatReader ? ZX.BrowserMultiFormatReader : null;
      if(!ok || !ReaderCtor){ note('ZXing no disponible. Usa la b√∫squeda manual.'); return; }

      try{
        const r=await fetch('/api/zxing.js', { cache:'no-store' });
        console.log('X-Precioreal-ZXing:', r.headers.get('X-Precioreal-ZXing')||'(sin cabecera)');
      }catch{}

      scannerReader = new ReaderCtor();
      scannerReader.decodeFromVideoDevice(null, video, (result)=>{
        const raw = result && result.getText ? result.getText() : '';
        if (!raw) return;
        onScan(raw);
      }).catch(err=>{
        console.error('decodeFromVideoDevice error', err);
        note('Fallo del motor de escaneo. Intenta de nuevo o usa modo manual.');
      });

      setScanButtonActive(true);
    }

    // Bot√≥n √∫nico Escanear/Detener
    $('btnScan').addEventListener('click', async ()=>{
      if (currentStream){
        stopScanner();
        setScanButtonActive(false);
      }else{
        await startScanner();
      }
    });

    // Torch y Test (en drawer)
    $('btnTorch').addEventListener('click', toggleTorch);
    $('btnTest').addEventListener('click', async ()=>{
      let txt='';
      if(navigator.permissions && navigator.permissions.query){ try{ const p=await navigator.permissions.query({name:'camera'}); txt+='Permiso c√°mara: '+p.state+'\n'; }catch(_){} }
      try{ const s=await navigator.mediaDevices.getUserMedia({video:true,audio:false}); s.getTracks().forEach(t=>t.stop()); txt+='getUserMedia: ‚úÖ OK\n'; }catch(e){ txt+='getUserMedia: ‚ùå '+(e.name||e.message)+'\n'; }
      const devs=await navigator.mediaDevices.enumerateDevices(); const list=devs.filter(d=>d.kind==='videoinput'); txt+='C√°maras detectadas: '+list.length+'\n'; list.forEach((d,i)=> txt+='- ['+i+'] '+(d.label||'(sin etiqueta)')+'\n');
      const vib = (navigator.vibrate && navigator.vibrate(60)) ? '‚úÖ' : (('vibrate' in navigator)?'‚ö†Ô∏è':'‚ùå');
      txt+='Vibraci√≥n: '+vib+'\n';
      note(txt||'Test hecho');
    });

    // Drawer (+)
    $('btnMore').addEventListener('click', ()=>{
      const d = $('drawer'); d.classList.toggle('open');
    });

    // PvP TIENDA (teclado num√©rico con enteros o dos decimales)
    function updatePvpPillText(){
      const rec=loadList(K_RECENTS)[0]||null;
      const el = $('pvpValue');
      if (!el){ return; }
      if (rec && rec.userPrice!=null){ el.textContent = fmtMoney(rec.userPrice)+' ‚Ç¨'; }
      else { el.textContent = '‚Äî'; }
    }

    function openKeypad(){
      const rec=loadList(K_RECENTS)[0]||null;
      if(!rec){ alert('Escanea o busca un producto primero.'); return; }

      const modal=document.createElement('div');
      modal.className='modal';
      modal.innerHTML=`
        <div class="card">
          <div class="kDisplay"><span>PvP Tienda</span><span id="kOut">${$('pvpValue').textContent || '‚Äî'}</span></div>
          <div class="kGrid">
            ${['1','2','3','4','5','6','7','8','9'].map(n=>`<button class="kBtn" data-k="${n}">${n}</button>`).join('')}
            <button class="kBtn" data-k=",">,</button>
            <button class="kBtn" data-k="0">0</button>
            <button class="kBtn del" data-k="del">‚å´</button>
          </div>
          <div class="kRow">
            <button class="kBtn secondary" id="kCancel">Cancelar</button>
            <button class="kBtn ok" id="kOk">Guardar</button>
          </div>
        </div>`;
      document.body.appendChild(modal);

      const out = modal.querySelector('#kOut');
      let buffer = (function(){
        const txt = $('pvpValue').textContent||'';
        const m = txt.match(/[\d]+(?:,[\d]{0,2})?/);
        return m ? m[0] : '';
      })();

      const setOut = ()=>{
        if (!buffer) { out.textContent = '‚Äî'; return; }
        // Mostrar con ,00 si no hay decimales
        if (!buffer.includes(',')) out.textContent = buffer + ',00';
        else {
          const parts = buffer.split(',');
          out.textContent = parts[0] + ',' + (parts[1].padEnd(2,'0').slice(0,2));
        }
      };
      setOut();

      modal.addEventListener('click', (e)=>{
        if(e.target===modal) modal.remove();
      });

      modal.querySelectorAll('.kBtn').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const k = btn.getAttribute('data-k');
          if(k==='del'){
            buffer = buffer.slice(0,-1);
            // Si borramos la coma final sobrante, dejamos solo enteros
            if (buffer.endsWith(',')) buffer = buffer.slice(0,-1);
            setOut(); 
            return; 
          }
          if(k===','){ 
            if(!buffer.includes(',')) buffer = buffer ? buffer+',' : '0,';
            setOut(); 
            return; 
          }
          // n√∫mero
          buffer += k;
          // limitar a 2 decimales si hay coma
          const parts = buffer.split(',');
          if(parts[1] && parts[1].length>2){ parts[1]=parts[1].slice(0,2); buffer=parts.join(','); }
          setOut();
        });
      });

      modal.querySelector('#kCancel').addEventListener('click', ()=> modal.remove());
      modal.querySelector('#kOk').addEventListener('click', ()=>{
        if(!buffer){ updateItemPvp(rec.id, null); updatePvpPillText(); modal.remove(); return; }
        // Convertir a n√∫mero: si no hay coma => entero
        let num;
        if (buffer.includes(',')){
          const parts = buffer.split(',');
          const dec = (parts[1]||'').padEnd(2,'0').slice(0,2);
          num = Number(parts[0] + '.' + dec);
        } else {
          num = Number(buffer); // entero
        }
        if(!isFinite(num)){ alert('Precio no v√°lido'); return; }
        updateItemPvp(rec.id, Math.max(0,num));
        updatePvpPillText();
        modal.remove();
      });
    }

    $('pvpPill').addEventListener('click', openKeypad);

    // Buscar manual
    $('btnBuscar').addEventListener('click', async ()=>{
      const code=$('eanInput').value.replace(/[^0-9]/g,''); const v=validCode(code);
      if(!v.ok){ setEanHint('C√≥digo no v√°lido.', false); return; }
      await lookupAndRender(code);
    });

    // Lookup backend
    async function lookupAndRender(ean){
      const cached=cacheGet(ean); if(cached){ renderResult(cached.success,cached.product,ean,cached.meta); return; }
      try{
        const r=await fetch('/api/lookup?ean='+encodeURIComponent(ean));
        const d=await r.json(); cacheSet(ean,d);
        renderResult(d && d.success, d && d.product, ean, d && d.meta);
      }catch(e){ note('No se pudo consultar el backend.'); }
    }

    // --- utilidades y validadores (sin cambios de l√≥gica) ---
    function removeRecent(id){ const arr=loadList(K_RECENTS).filter(x=>x.id!==id); saveList(K_RECENTS,arr); renderRecents(); }
    function clearRecents(){ saveList(K_RECENTS,[]); renderRecents(); }
    function isFav(id){ return loadList(K_FAVS).some(x=>x.id===id); }
    function toggleFav(item){ if(!item||!item.id) return; const arr=loadList(K_FAVS); const i=arr.findIndex(x=>x.id===item.id); if(i>=0) arr.splice(i,1); else arr.unshift(item); saveList(K_FAVS,arr); renderFavs(); renderRecents(); }
    function clearFavs(){ saveList(K_FAVS,[]); renderFavs(); renderRecents(); }

    $('btnClearRecents').addEventListener('click', ()=>{ if(confirm('¬øVaciar lista de √∫ltimos escaneados?')) clearRecents(); });
    $('btnClearFavs').addEventListener('click', ()=>{ if(confirm('¬øVaciar favoritos?')) clearFavs(); });

    // Render inicial
    renderRecents(); renderFavs(); renderToggles(); updatePvpPillText();

    // --------- Validaci√≥n EAN/UPC ----------
    function ean13Valid(s){ s=String(s).replace(/[^0-9]/g,''); if(s.length!==13) return false; const d=s.split('').map(n=>+n); const c=d[12]; let sum=0; for(let i=0;i<12;i++) sum+=d[i]*(i%2===0?1:3); return ((10-(sum%10))%10)===c; }
    function ean8Valid(s){ s=String(s).replace(/[^0-9]/g,''); if(s.length!==8) return false; const d=s.split('').map(n=>+n); const c=d[7]; let sum=0; for(let i=0;i<7;i++) sum+=d[i]*(i%2===0?3:1); return ((10-(sum%10))%10)===c; }
    function upcAValid(s){ s=String(s).replace(/[^0-9]/g,''); if(s.length!==12) return false; return ean13Valid('0'+s); }
    function validCode(code){ const s=String(code).replace(/[^0-9]/g,''); if(s.length===13) return {ok:ean13Valid(s),type:'EAN-13'}; if(s.length===8) return {ok:ean8Valid(s),type:'EAN-8'}; if(s.length===12) return {ok:upcAValid(s),type:'UPC-A'}; return {ok:false,type:'unknown'}; }
    function setEanHint(msg, ok){ const el=$('eanHint'); el.textContent=msg||''; el.style.color=ok?'#9fe29f':'#ffb3b3'; }

  })();
  </script>
</body>
</html>
