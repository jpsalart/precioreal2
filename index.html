<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PrecioReal ¬∑ Escanea y ve el precio en Amazon</title>
  <meta name="description" content="Escanea c√≥digos de barras (EAN/ISBN/UPC) y consulta el precio en Amazon.">
  <style>
    :root{
      --bg:#0b0f14; --panel:#121824; --panel2:#0f1520;
      --text:#e7edf7; --muted:#a8b3c7;
      --brand:#3aa1ff; --brand2:#1e78d5;
      --bd:#1a2434;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:720px;margin:0 auto;padding:16px}
    header{display:flex;align-items:center;gap:12px;padding:16px 0;border-bottom:1px solid var(--bd)}
    .logo{width:40px;height:40px;border-radius:10px;display:grid;place-items:center;background:linear-gradient(135deg,var(--brand),#7cc8ff);color:#041423;font-weight:900}
    h1{font-size:18px;margin:0}
    .muted{color:var(--muted)}
    .panel{background:var(--panel);border:1px solid var(--bd);border-radius:14px;padding:14px;margin:16px 0}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:12px 16px;border:0;border-radius:12px;cursor:pointer;background:linear-gradient(180deg,var(--brand),var(--brand2));color:#06121f;font-weight:800}
    .btn.secondary{background:#182339;color:var(--text);border:1px solid #223352}
    .row{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
    .row input{flex:1;min-width:180px;padding:12px;border-radius:12px;border:1px solid #223352;background:#0c1322;color:var(--text)}
    #scanner{aspect-ratio:3/2;background:#0d1423;border:1px dashed #223352;border-radius:12px;display:grid;place-items:center;overflow:hidden;margin-top:12px;padding:10px;text-align:center}
    .card{display:grid;grid-template-columns:88px 1fr;gap:12px;align-items:center;background:#0d1423;border:1px solid var(--bd);border-radius:12px;padding:12px}
    .thumb{width:88px;height:88px;border-radius:10px;overflow:hidden;background:#101a2c;display:grid;place-items:center}
    .thumb img{width:100%;height:100%;object-fit:cover}
    .title{font-weight:700;line-height:1.25}
    .price{font-weight:900;font-size:18px;margin-top:4px}
    .cta{margin-top:8px}
    .link{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:10px;background:#182339;border:1px solid #223352;color:var(--text);text-decoration:none}
    .disclaimer{font-size:12px;color:var(--muted);margin-top:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo">PR</div>
      <div>
        <h1>PrecioReal</h1>
        <div class="muted">Escanea un producto y mira su precio en Amazon</div>
      </div>
    </header>

    <section class="panel">
      <b>Escanear con la c√°mara</b>
      <div id="scanner">Pulsa ‚ÄúIniciar esc√°ner‚Äù y permite el uso de la c√°mara</div>
      <div class="row">
        <button class="btn" id="btnScan">Iniciar esc√°ner</button>
        <button class="btn secondary" id="btnStop">Parar</button>
        <button class="btn secondary" id="btnTest">Test c√°mara</button>
      </div>
    </section>

    <section class="panel">
      <b>O introduce el c√≥digo (EAN/ISBN/UPC)</b>
      <div class="row">
        <input id="eanInput" inputmode="numeric" pattern="[0-9]*" placeholder="Ej.: 9788408306863" />
        <button class="btn secondary" id="btnBuscar">Buscar</button>
      </div>
    </section>

    <section class="panel" id="resultado" style="display:none">
      <div class="card">
        <div class="thumb" id="thumb">‚Äî</div>
        <div>
          <div class="title" id="title">‚Äî</div>
          <div class="muted" id="category">‚Äî</div>
          <div class="price" id="price">‚Äî</div>
          <div class="cta"><a class="link" id="amazonLink" target="_blank" rel="noopener">üõí Ver en Amazon</a></div>
        </div>
      </div>
      <div class="disclaimer">Como Asociado de Amazon, gano por compras calificadas.</div>
    </section>
  </div>

  <script>
  (function(){
    'use strict';

    // ------------ Helpers UI ------------
    function $(id){ return document.getElementById(id); }
    function showError(msg) {
      var cont = $('scanner');
      cont.style.color = '#ffb3b3';
      cont.style.fontSize = '14px';
      cont.textContent = '‚ö†Ô∏è ' + msg;
      console.error(msg);
    }
    function showInfo(msg) {
      var cont = $('scanner');
      cont.style.color = '#cfe7ff';
      cont.style.fontSize = '14px';
      cont.textContent = msg;
    }
    function renderResult(ok, p, ean) {
      p = p || {}; ean = ean || '';
      var box = $('resultado');
      var thumb = $('thumb');
      var title = $('title');
      var cat = $('category');
      var price = $('price');
      var link = $('amazonLink');
      if (!ok) {
        box.style.display = 'block';
        thumb.textContent = '‚Äî';
        title.textContent = 'No encontrado para ' + ean;
        cat.textContent = '‚Äî';
        price.textContent = '‚Äî';
        link.href = '#';
        return;
      }
      thumb.innerHTML = p.image ? '<img alt="Imagen" src="'+p.image+'">' : '‚Äî';
      title.textContent = p.title || ('C√≥digo ' + ean);
      cat.textContent = p.category || '‚Äî';
      price.textContent = p.price ? (p.price + ' ‚Ç¨') : '‚Äî';
      link.href = p.affiliateLink || '#';
      box.style.display = 'block';
      box.scrollIntoView({ behavior:'smooth', block:'start' });
    }
    async function lookupAndRender(ean) {
      try {
        var res = await fetch('/api/lookup?ean=' + encodeURIComponent(ean));
        var data = await res.json();
        renderResult(data && data.success, data && data.product, ean);
      } catch (e) {
        showError('No se pudo consultar el backend (/api/lookup).');
        renderResult(false, {}, ean);
      }
    }

    // ------------ Esc√°ner: BarcodeDetector nativo ------------
    var currentStream = null;
    var stopRequested = false;

    function stopScanner() {
      stopRequested = true;
      try { if (currentStream) currentStream.getTracks().forEach(function(t){ t.stop(); }); } catch(_){}
      currentStream = null;
      $('scanner').textContent = 'Esc√°ner detenido';
    }

    async function startScanner() {
      showInfo('Preparando c√°mara‚Ä¶');

      // 1) ¬øHay API nativa?
      var NativeBD = ('BarcodeDetector' in window) ? window.BarcodeDetector : null;

      // 2) Si NO hay API nativa y NO tienes ZXing local, avisamos y salimos
      if (!NativeBD) {
        // Intento cargar ZXing autoalojado, por si lo subiste en /vendor/zxing/index.min.js
        try {
          await new Promise(function(resolve, reject){
            var s = document.createElement('script');
            s.src = '/vendor/zxing/index.min.js'; // s√∫belo t√∫ (ver instrucciones debajo)
            s.async = true;
            s.onload = resolve;
            s.onerror = reject;
            document.head.appendChild(s);
          });
        } catch(_){}
      }

      // Revisa de nuevo: ¬øse carg√≥ ZXing?
      var ZX = window.ZXingBrowser || window.ZXing || null;
      var ZXReader = ZX ? ZX.BrowserMultiFormatReader : null;

      if (!NativeBD && !ZXReader) {
        showError('Tu navegador no soporta escaneo nativo y no se encontr√≥ ZXing local. Usa la b√∫squeda manual o sube /vendor/zxing/index.min.js');
        return;
      }

      // 3) Prepara <video> compatible iOS
      var cont = $('scanner');
      var video = document.createElement('video');
      video.setAttribute('playsinline','');
      video.setAttribute('autoplay','');
      video.setAttribute('muted','');
      video.muted = true;
      video.style.width = '100%';
      cont.replaceChildren(video);

      stopRequested = false;

      try {
        // Pedimos permiso sin deviceId (iOS etiqueta c√°maras)
        var prov = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { ideal: 'environment' } }, audio:false });
        prov.getTracks().forEach(function(t){ t.stop(); });

        // Elegimos c√°mara trasera si se puede
        var devs = await navigator.mediaDevices.enumerateDevices();
        var cams = devs.filter(function(d){ return d.kind === 'videoinput'; });
        var deviceId = null;
        if (cams.length) {
          var back = cams.find(function(d){ return /back|rear|environment|atr√°s|tr√°s/i.test(d.label||''); }) || cams[cams.length - 1];
          deviceId = back && back.deviceId;
        }

        // Abrimos stream
        try {
          currentStream = deviceId
            ? await navigator.mediaDevices.getUserMedia({ video:{ deviceId:{ exact: deviceId } }, audio:false })
            : await navigator.mediaDevices.getUserMedia({ video:{ facingMode:{ ideal:'environment' } }, audio:false });
        } catch(_){
          currentStream = await navigator.mediaDevices.getUserMedia({ video:true, audio:false });
        }
        video.srcObject = currentStream;
        await video.play();

        // 4) Camino A: BarcodeDetector nativo
        if (NativeBD) {
          showInfo('Escaneando (motor nativo)‚Ä¶');
          var detector = new NativeBD({
            formats: ['ean_13','ean_8','upc_a','upc_e','code_128','code_39','qr_code']
          });
          var lastTs = 0;

          async function tick(ts){
            if (stopRequested || !currentStream) return;
            // Limita a ~5 detecciones/segundo
            if (ts - lastTs >= 180) {
              lastTs = ts;
              try {
                const trackSettings = (currentStream.getVideoTracks()[0] || {}).getSettings?.() || {};
                const w = trackSettings.width || video.videoWidth || 640;
                const h = trackSettings.height || video.videoHeight || 480;
                // Usa un frame actual mediante ImageBitmap (m√°s r√°pido que canvas en muchos m√≥viles)
                const bitmap = await createImageBitmap(video, 0, 0, w, h);
                const codes = await detector.detect(bitmap);
                bitmap.close?.();
                if (codes && codes.length) {
                  const raw = codes[0].rawValue || '';
                  const code = String(raw).replace(/[^0-9Xx]/g,'');
                  if (code) {
                    stopScanner();
                    await lookupAndRender(code);
                    return;
                  }
                }
              } catch(_){}
            }
            video.requestVideoFrameCallback ? video.requestVideoFrameCallback(tick) : requestAnimationFrame(tick);
          }
          video.requestVideoFrameCallback ? video.requestVideoFrameCallback(tick) : requestAnimationFrame(tick);
          return;
        }

        // 5) Camino B: ZXing autoalojado
        if (ZXReader) {
          showInfo('Escaneando (ZXing)‚Ä¶');
          var reader = new ZXReader();
          await reader.decodeFromVideoDevice(deviceId || null, video, async function(result, err){
            if (stopRequested || !currentStream) return;
            if (result && result.getText) {
              const code = (result.getText() || '').replace(/[^0-9Xx]/g,'');
              if (code) {
                stopScanner();
                await lookupAndRender(code);
              }
            }
          });
          return;
        }

      } catch (e) {
        if (e && (e.name === 'NotAllowedError' || e.name === 'PermissionDeniedError')) {
          showError('Permiso de c√°mara denegado. Act√≠valo en los ajustes del navegador.');
        } else if (e && (e.name === 'NotFoundError' || e.name === 'DevicesNotFoundError')) {
          showError('No hay c√°mara disponible en este dispositivo.');
        } else if (e && e.message && e.message.indexOf('Only secure origins') >= 0) {
          showError('La c√°mara solo funciona en sitios HTTPS (candado en la URL).');
        } else {
          showError('No se pudo iniciar la c√°mara. Usa el campo manual.');
          console.error(e);
        }
      }
    }

    // ------------ Test c√°mara ------------
    async function testCamera() {
      var cont = $('scanner');
      try {
        var txt = '';
        txt += 'BarcodeDetector: ' + (('BarcodeDetector' in window) ? '‚úÖ disponible' : '‚ùå NO disponible') + '\n';

        if (navigator.permissions && navigator.permissions.query) {
          try {
            var p = await navigator.permissions.query({ name:'camera' });
            txt += 'Permiso c√°mara: ' + p.state + '\n';
          } catch(_){}
        }

        try {
          var s = await navigator.mediaDevices.getUserMedia({ video:true, audio:false });
          s.getTracks().forEach(function(t){ t.stop(); });
          txt += 'getUserMedia: ‚úÖ OK\n';
        } catch (e) {
          txt += 'getUserMedia: ‚ùå ' + (e.name || e.message) + '\n';
        }

        var devs = await navigator.mediaDevices.enumerateDevices();
        var cams = devs.filter(function(d){ return d.kind==='videoinput'; });
        txt += 'C√°maras detectadas: ' + cams.length + '\n';
        cams.forEach(function(d,i){ txt += '- ['+i+'] ' + (d.label || '(sin etiqueta)') + '\n';

        });
        cont.textContent = txt;
        cont.style.whiteSpace = 'pre-wrap';
        cont.style.color = '#cfe7ff';
      } catch (e) {
        showError('Test fall√≥: ' + (e.name || '') + ' ' + (e.message || e));
      }
    }

    // ------------ Eventos UI ------------
    $('btnScan').addEventListener('click', startScanner);
    $('btnStop').addEventListener('click', stopScanner);
    $('btnTest').addEventListener('click', testCamera);
    $('btnBuscar').addEventListener('click', async function(){
      var code = $('eanInput').value.trim();
      if (code) await lookupAndRender(code);
    });

  })();
  </script>
</body>
</html>
