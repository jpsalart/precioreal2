<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PrecioReal ¬∑ Escanea y ve el precio en Amazon</title>
  <meta name="description" content="Escanea c√≥digos de barras (EAN/ISBN/UPC) y consulta el precio en Amazon.">
  <style>
    :root{ --bg:#0b0f14; --panel:#121824; --text:#e7edf7; --muted:#a8b3c7; --brand:#3aa1ff; --brand2:#1e78d5; --bd:#1a2434; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:720px;margin:0 auto;padding:16px}
    header{display:flex;align-items:center;gap:12px;padding:16px 0;border-bottom:1px solid var(--bd)}
    .logo{width:40px;height:40px;border-radius:10px;display:grid;place-items:center;background:linear-gradient(135deg,var(--brand),#7cc8ff);color:#041423;font-weight:900}
    h1{font-size:18px;margin:0}.muted{color:var(--muted)}
    .panel{background:var(--panel);border:1px solid var(--bd);border-radius:14px;padding:14px;margin:16px 0}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:12px 16px;border:0;border-radius:12px;cursor:pointer;background:linear-gradient(180deg,var(--brand),var(--brand2));color:#06121f;font-weight:800}
    .btn.secondary{background:#182339;color:var(--text);border:1px solid #223352}
    .row{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
    .row input{flex:1;min-width:180px;padding:12px;border-radius:12px;border:1px solid #223352;background:#0c1322;color:var(--text)}
    #scanner{position:relative;aspect-ratio:3/2;background:#0d1423;border:1px dashed #223352;border-radius:12px;display:grid;place-items:center;overflow:hidden;margin-top:12px;padding:10px;text-align:center}
    #scanner video{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
    #overlayMsg{position:absolute;bottom:8px;left:8px;right:8px;background:rgba(0,0,0,.45);border:1px solid #223352;border-radius:8px;padding:6px 8px;font-size:12px;color:#cfe7ff}
    .card{display:grid;grid-template-columns:88px 1fr;gap:12px;align-items:center;background:#0d1423;border:1px solid var(--bd);border-radius:12px;padding:12px}
    .thumb{width:88px;height:88px;border-radius:10px;overflow:hidden;background:#101a2c;display:grid;place-items:center}
    .thumb img{width:100%;height:100%;object-fit:cover}
    .title{font-weight:700;line-height:1.25}.price{font-weight:900;font-size:18px;margin-top:4px}
    .cta{margin-top:8px}.link{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:10px;background:#182339;border:1px solid #223352;color:var(--text);text-decoration:none}
    .disclaimer{font-size:12px;color:var(--muted);margin-top:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo">PR</div>
      <div>
        <h1>PrecioReal</h1>
        <div class="muted">Escanea un producto y mira su precio en Amazon</div>
      </div>
    </header>

    <section class="panel">
      <b>Escanear con la c√°mara</b>
      <div id="scanner">
        <div id="overlayMsg">Pulsa ‚ÄúIniciar esc√°ner‚Äù y permite la c√°mara</div>
      </div>
      <div class="row">
        <button class="btn" id="btnScan">Iniciar esc√°ner</button>
        <button class="btn secondary" id="btnStop">Parar</button>
        <button class="btn secondary" id="btnForceZX">Forzar ZXing</button>
        <button class="btn secondary" id="btnTest">Test c√°mara</button>
      </div>
    </section>

    <section class="panel">
      <b>O introduce el c√≥digo (EAN/ISBN/UPC)</b>
      <div class="row">
        <input id="eanInput" inputmode="numeric" pattern="[0-9]*" placeholder="Ej.: 9788408306863" />
        <button class="btn secondary" id="btnBuscar">Buscar</button>
      </div>
    </section>

    <section class="panel" id="resultado" style="display:none">
      <div class="card">
        <div class="thumb" id="thumb">‚Äî</div>
        <div>
          <div class="title" id="title">‚Äî</div>
          <div class="muted" id="category">‚Äî</div>
          <div class="price" id="price">‚Äî</div>
          <div class="cta"><a class="link" id="amazonLink" target="_blank" rel="noopener">üõí Ver en Amazon</a></div>
        </div>
      </div>
      <div class="disclaimer">Como Asociado de Amazon, gano por compras calificadas.</div>
    </section>
  </div>

  <script>
  (function(){
    'use strict';

    // ---------- Helpers UI ----------
    function $(id){ return document.getElementById(id); }
    function note(msg) {
      const o = $('overlayMsg'); if (!o) return;
      o.textContent = msg; o.style.display = 'block';
    }
    function hideNote() { const o = $('overlayMsg'); if (o) o.style.display = 'none'; }
    function renderResult(ok, p, ean){
      p=p||{}; ean=ean||'';
      const box=$('resultado'), thumb=$('thumb'), title=$('title'), cat=$('category'), price=$('price'), link=$('amazonLink');
      if(!ok){ box.style.display='block'; thumb.textContent='‚Äî'; title.textContent='No encontrado para '+ean; cat.textContent='‚Äî'; price.textContent='‚Äî'; link.href='#'; return; }
      thumb.innerHTML = p.image ? '<img alt="Imagen" src="'+p.image+'">' : '‚Äî';
      title.textContent = p.title || ('C√≥digo '+ean);
      cat.textContent = p.category || '‚Äî';
      price.textContent = p.price ? (p.price+' ‚Ç¨') : '‚Äî';
      link.href = p.affiliateLink || '#';
      box.style.display='block'; box.scrollIntoView({behavior:'smooth', block:'start'});
    }
    async function lookupAndRender(ean){
      try{ const r=await fetch('/api/lookup?ean='+encodeURIComponent(ean)); const d=await r.json(); renderResult(d&&d.success, d&&d.product, ean); }
      catch(e){ note('No se pudo consultar el backend.'); renderResult(false,{},ean); }
    }

    // ---------- C√°mara ----------
    let currentStream=null, stopRequested=false;
    function stopScanner(){
      stopRequested = true;
      try{ if(currentStream) currentStream.getTracks().forEach(t=>t.stop()); }catch(_){}
      currentStream=null; note('Esc√°ner detenido');
    }
    async function getBestDeviceId(){
      const devs = await navigator.mediaDevices.enumerateDevices();
      const cams = devs.filter(d => d.kind==='videoinput');
      if (!cams.length) return null;
      const back = cams.find(d => /back|rear|environment|atr√°s|tr√°s/i.test(d.label||'')) || cams[cams.length-1];
      return back.deviceId || null;
    }
    async function openStream(deviceId){
      try {
        return deviceId
          ? await navigator.mediaDevices.getUserMedia({ video:{ deviceId:{ exact: deviceId } }, audio:false })
          : await navigator.mediaDevices.getUserMedia({ video:{ facingMode:{ ideal:'environment' } }, audio:false });
      } catch(_){
        return await navigator.mediaDevices.getUserMedia({ video:true, audio:false });
      }
    }

    // ---------- Motores ----------
    async function loadZXing(){
      if (window.ZXingBrowser || window.ZXing) return true;
      return new Promise(resolve=>{
        const s=document.createElement('script'); s.src='/api/zxing.js'; s.async=true;
        s.onload=()=>resolve(!!(window.ZXingBrowser||window.ZXing));
        s.onerror=()=>resolve(false);
        document.head.appendChild(s);
      });
    }

    async function startNativeLoop(video){
      note('Escaneando (motor nativo)‚Ä¶');
      const NativeBD = window.BarcodeDetector;
      const detector = new NativeBD({ formats: ['ean_13','ean_8','upc_a','upc_e','code_128','code_39','qr_code'] });
      let last=0, frames=0, found=false;

      async function tick(ts){
        if (stopRequested || !currentStream) return;
        if (ts - last >= 150) {
          last = ts; frames++;
          try {
            // M√°s fiable que pasar el <video> directamente en muchos m√≥viles
            const settings = (currentStream.getVideoTracks()[0]||{}).getSettings?.() || {};
            const w = settings.width || video.videoWidth || 640;
            const h = settings.height || video.videoHeight || 480;
            const bmp = await createImageBitmap(video, 0, 0, w, h);
            const codes = await detector.detect(bmp);
            bmp.close && bmp.close();
            if (codes && codes.length) {
              const raw = codes[0].rawValue || '';
              const code = String(raw).replace(/[^0-9Xx]/g,'');
              if (code) {
                found = true;
                stopScanner();
                await lookupAndRender(code);
                return;
              }
            }
          } catch(_){}
        }
        (video.requestVideoFrameCallback || requestAnimationFrame)(tick);
      }

      // Fallback a ZXing si en 4s no hay frames/detecci√≥n
      setTimeout(async ()=>{
        if (!found) {
          note('Cambiando a ZXing‚Ä¶');
          await startZXingLoop(video);
        }
      }, 4000);

      (video.requestVideoFrameCallback || requestAnimationFrame)(tick);
    }

    async function startZXingLoop(video){
      const ok = await loadZXing();
      const ZX = window.ZXingBrowser || window.ZXing || null;
      const Reader = ZX && ZX.BrowserMultiFormatReader ? ZX.BrowserMultiFormatReader : null;
      if (!ok || !Reader) { note('ZXing no disponible. Usa el modo manual.'); return; }
      note('Escaneando (ZXing)‚Ä¶');
      const reader = new Reader();
      const deviceId = await getBestDeviceId();
      await reader.decodeFromVideoDevice(deviceId || null, video, async (result, err)=>{
        if (stopRequested || !currentStream) return;
        if (result && result.getText) {
          const code = (result.getText()||'').replace(/[^0-9Xx]/g,'');
          if (code) { stopScanner(); await lookupAndRender(code); }
        }
      });
    }

    // ---------- Flujo principal ----------
    async function startScanner(forceZX){
      note('Preparando c√°mara‚Ä¶');
      const cont = document.getElementById('scanner');
      const video = document.createElement('video');
      video.setAttribute('playsinline',''); video.setAttribute('autoplay',''); video.setAttribute('muted','');
      video.muted = true; video.playsInline = true;
      cont.replaceChildren(video, (function(){ const m=document.createElement('div'); m.id='overlayMsg'; return m;})());

      try{
        // Pide permiso ‚Äúciego‚Äù primero (etiquetas en iOS)
        const prov = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:{ ideal:'environment' } }, audio:false });
        prov.getTracks().forEach(t=>t.stop());

        // Abre stream real
        const deviceId = await getBestDeviceId();
        currentStream = await openStream(deviceId);
        video.srcObject = currentStream;
        await video.play();
        hideNote(); // ya deber√≠a verse el v√≠deo

        if (forceZX) {
          await startZXingLoop(video);
        } else if ('BarcodeDetector' in window) {
          await startNativeLoop(video);
        } else {
          await startZXingLoop(video);
        }

      } catch(e){
        if (e && (e.name==='NotAllowedError'||e.name==='PermissionDeniedError')) note('Permiso de c√°mara denegado. Act√≠valo en los ajustes del navegador.');
        else if (e && (e.name==='NotFoundError'||e.name==='DevicesNotFoundError')) note('No hay c√°mara disponible en este dispositivo.');
        else if (e && e.message && e.message.indexOf('Only secure origins')>=0) note('La c√°mara solo funciona en sitios HTTPS (candado en la URL).');
        else { note('No se pudo iniciar la c√°mara. Usa la b√∫squeda manual.'); console.error(e); }
      }
    }

    // ---------- Test ----------
    async function testCamera(){
      let txt = 'BarcodeDetector: ' + (('BarcodeDetector' in window) ? '‚úÖ' : '‚ùå') + '\n';
      if (navigator.permissions && navigator.permissions.query) {
        try { const p = await navigator.permissions.query({ name:'camera' }); txt += 'Permiso c√°mara: ' + p.state + '\n'; } catch(_){}
      }
      try { const s = await navigator.mediaDevices.getUserMedia({ video:true, audio:false }); s.getTracks().forEach(t=>t.stop()); txt += 'getUserMedia: ‚úÖ OK\n'; } catch(e){ txt += 'getUserMedia: ‚ùå ' + (e.name||e.message) + '\n'; }
      const devs = await navigator.mediaDevices.enumerateDevices();
      const cams = devs.filter(d=>d.kind==='videoinput');
      txt += 'C√°maras detectadas: ' + cams.length + '\n';
      cams.forEach((d,i)=> txt += '- ['+i+'] ' + (d.label || '(sin etiqueta)') + '\n');
      note(txt);
    }

    // Eventos
    document.getElementById('btnScan').addEventListener('click', ()=>startScanner(false));
    document.getElementById('btnForceZX').addEventListener('click', ()=>startScanner(true));
    document.getElementById('btnStop').addEventListener('click', stopScanner);
    document.getElementById('btnTest').addEventListener('click', testCamera);
    document.getElementById('btnBuscar').addEventListener('click', async ()=>{
      const code = document.getElementById('eanInput').value.trim();
      if (code) await lookupAndRender(code);
    });
  })();
  </script>
</body>
</html>
