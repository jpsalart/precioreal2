<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PrecioReal ¬∑ Escanea y ve el precio en Amazon</title>
  <style>
    body{margin:0;font-family:system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif;background:#0b0f14;color:#e7edf7}
    .wrap{max-width:720px;margin:0 auto;padding:16px}
    header{display:flex;align-items:center;gap:12px;padding:16px 0;border-bottom:1px solid #1a2434}
    .logo{width:40px;height:40px;border-radius:10px;display:grid;place-items:center;background:linear-gradient(135deg,#3aa1ff,#7cc8ff);color:#041423;font-weight:900}
    h1{font-size:18px;margin:0}
    .panel{background:#121824;border:1px solid #1a2434;border-radius:14px;padding:14px;margin:16px 0}
    .muted{color:#a8b3c7}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:12px 16px;border:0;border-radius:12px;cursor:pointer;background:linear-gradient(180deg,#3aa1ff,#1e78d5);color:#06121f;font-weight:800}
    .btn.secondary{background:#182339;color:#e7edf7;border:1px solid #223352}
    .row{display:flex;gap:8px;margin-top:10px}
    .row input{flex:1;padding:12px;border-radius:12px;border:1px solid #223352;background:#0c1322;color:#e7edf7}
    #scanner{aspect-ratio:3/2;background:#0d1423;border:1px dashed #223352;border-radius:12px;display:grid;place-items:center;overflow:hidden;margin-top:12px}
    .card{display:grid;grid-template-columns:88px 1fr;gap:12px;align-items:center;background:#0d1423;border:1px solid #1a2434;border-radius:12px;padding:12px}
    .thumb{width:88px;height:88px;border-radius:10px;overflow:hidden;background:#101a2c;display:grid;place-items:center}
    .thumb img{width:100%;height:100%;object-fit:cover}
    .title{font-weight:700;line-height:1.25}
    .price{font-weight:900;font-size:18px;margin-top:4px}
    .cta{margin-top:8px}
    .link{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:10px;background:#182339;border:1px solid #223352;color:#e7edf7;text-decoration:none}
    .disclaimer{font-size:12px;color:#a8b3c7;margin-top:8px}
  </style>
  <!-- ZXing (lector de c√≥digos en el navegador) -->
<script src="https://cdn.jsdelivr.net/npm/@zxing/browser@0.1.7/umd/index.min.js"
        onerror="var s=document.createElement('script');s.src='https://unpkg.com/@zxing/browser@0.1.7/umd/index.min.js';document.head.appendChild(s)">
</script>

</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo">PR</div>
      <div>
        <h1>PrecioReal</h1>
        <div class="muted">Escanea un producto y mira su precio en Amazon</div>
      </div>
    </header>

    <section class="panel">
      <b>Escanear con la c√°mara</b>
      <div id="scanner">Pulsa ‚ÄúIniciar esc√°ner‚Äù y permite el uso de la c√°mara</div>
<div class="row">
  <button class="btn" id="btnScan">Iniciar esc√°ner</button>
  <button class="btn secondary" id="btnStop">Parar</button>
  <button class="btn secondary" id="btnTest">Test c√°mara</button>
</div>

    </section>

    <section class="panel">
      <b>O introduce el c√≥digo (EAN/ISBN/UPC)</b>
      <div class="row">
        <input id="eanInput" inputmode="numeric" pattern="[0-9]*" placeholder="Ej.: 9788408306863" />
        <button class="btn secondary" id="btnBuscar">Buscar</button>
      </div>
    </section>

    <section class="panel" id="resultado" style="display:none">
      <div class="card">
        <div class="thumb" id="thumb">‚Äî</div>
        <div>
          <div class="title" id="title">‚Äî</div>
          <div class="muted" id="category">‚Äî</div>
          <div class="price" id="price">‚Äî</div>
          <div class="cta"><a class="link" id="amazonLink" target="_blank" rel="noopener">üõí Ver en Amazon</a></div>
        </div>
      </div>
      <div class="disclaimer">Como Asociado de Amazon, gano por compras calificadas.</div>
    </section>
  </div>

<script>
  const { BrowserMultiFormatReader } = ZXingBrowser;
  let reader, currentStream;

  // Muestra errores visibles en el recuadro
  function showError(msg) {
    const cont = document.getElementById('scanner');
    cont.style.color = '#ffb3b3';
    cont.style.fontSize = '14px';
    cont.textContent = `‚ö†Ô∏è ${msg}`;
    console.error(msg);
  }

  // Pinta el resultado
  function renderResult(ok, p = {}, ean = '') {
    const box = document.getElementById('resultado');
    const thumb = document.getElementById('thumb');
    const title = document.getElementById('title');
    const cat = document.getElementById('category');
    const price = document.getElementById('price');
    const link = document.getElementById('amazonLink');

    if (!ok) {
      box.style.display = 'block';
      thumb.textContent = '‚Äî';
      title.textContent = `No encontrado para ${ean}`;
      cat.textContent = '‚Äî';
      price.textContent = '‚Äî';
      link.href = '#';
      return;
    }
    thumb.innerHTML = p.image ? `<img alt="Imagen" src="${p.image}">` : '‚Äî';
    title.textContent = p.title || `C√≥digo ${ean}`;
    cat.textContent = p.category || '‚Äî';
    price.textContent = p.price ? `${p.price} ‚Ç¨` : '‚Äî';
    link.href = p.affiliateLink || '#';
    box.style.display = 'block';
    box.scrollIntoView({ behavior:'smooth', block:'start' });
  }

  // Llamada al backend
  async function lookupAndRender(ean) {
    try {
      const res = await fetch(`/api/lookup?ean=${encodeURIComponent(ean)}`);
      const data = await res.json();
      renderResult(data.success, data.product, ean);
    } catch (e) {
      showError('No se pudo consultar el backend (/api/lookup).');
      renderResult(false, {}, ean);
    }
  }

  // Detener esc√°ner
  function stopScanner() {
    try { reader?.reset(); } catch {}
    try { currentStream?.getTracks()?.forEach(t => t.stop()); } catch {}
    currentStream = null;
    document.getElementById('scanner').textContent = 'Esc√°ner detenido';
  }

  // Fallback en cadena para abrir la c√°mara:
  async function openStreamWithFallback(deviceId) {
    // 1) Intento con deviceId concreto (trasera elegida)
    if (deviceId) {
      try {
        return await navigator.mediaDevices.getUserMedia({ video: { deviceId: { exact: deviceId } }, audio: false });
      } catch {}
    }
    // 2) Intento con facingMode environment
    try {
      return await navigator.mediaDevices.getUserMedia({ video: { facingMode: { ideal: 'environment' } }, audio: false });
    } catch {}
    // 3) √öltimo recurso: cualquier c√°mara
    return await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
  }

  async function startScanner() {
    const cont = document.getElementById('scanner');

    // <video> compatible con iOS (muted + playsinline + autoplay)
    const video = document.createElement('video');
    video.setAttribute('playsinline','');
    video.setAttribute('autoplay','');
    video.setAttribute('muted','');
    video.muted = true;
    video.style.width = '100%';
    cont.replaceChildren(video);

    try {
      // Pedimos permiso primero (sin deviceId) para que iOS/Android etiqueten c√°maras
      const provisional = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { ideal: 'environment' } }, audio: false });
      provisional.getTracks().forEach(t => t.stop());

      // Enumeramos c√°maras ahora que ya hay permiso
      const all = (await navigator.mediaDevices.enumerateDevices()).filter(d => d.kind === 'videoinput');
      if (!all.length) { showError('No se encontr√≥ ninguna c√°mara.'); return; }

      // Heur√≠stica de ‚Äútrasera‚Äù
      const back = all.find(d => /back|rear|environment|tr√°s|atr√°s/i.test(d.label)) || all[all.length - 1];
      const deviceId = back?.deviceId;

      // Abrimos con fallback
      currentStream = await openStreamWithFallback(deviceId);
      video.srcObject = currentStream;
      await video.play();

      // ZXing
      reader = new BrowserMultiFormatReader();
      // Si tenemos deviceId √∫salo; si no, null para que use la default
      await reader.decodeFromVideoDevice(deviceId ?? null, video, async (result, err) => {
        if (result) {
          stopScanner();
          const code = (result.getText() || '').replace(/[^0-9Xx]/g,'');
          if (code) await lookupAndRender(code);
        }
      });

    } catch (e) {
      if (e && (e.name === 'NotAllowedError' || e.name === 'PermissionDeniedError')) {
        showError('Permiso de c√°mara denegado. Act√≠valo en los ajustes del navegador.');
      } else if (e && (e.name === 'NotFoundError' || e.name === 'DevicesNotFoundError')) {
        showError('No hay c√°mara disponible en este dispositivo.');
      } else if (e && e.message?.includes('Only secure origins')) {
        showError('La c√°mara solo funciona en sitios HTTPS (candado).');
      } else {
        showError('No se pudo iniciar la c√°mara. Usa el campo manual.');
        console.error(e);
      }
    }
  }

  // Bot√≥n de test r√°pido: te dice si hay permisos, c√°maras y por qu√© falla
  async function testCamera() {
    const cont = document.getElementById('scanner');
    try {
      let txt = '';
      // Estado de permiso si est√° disponible
      const p = navigator.permissions && navigator.permissions.query ? await navigator.permissions.query({ name: 'camera' }) : null;
      if (p) txt += `Permiso c√°mara: ${p.state}\n`;
      // Prueba getUserMedia simple
      try {
        const s = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
        s.getTracks().forEach(t=>t.stop());
        txt += 'getUserMedia: ‚úÖ OK\n';
      } catch (e) {
        txt += `getUserMedia: ‚ùå ${e.name}\n`;
      }
      // Enumerar dispositivos
      const devs = (await navigator.mediaDevices.enumerateDevices()).filter(d => d.kind === 'videoinput');
      txt += `C√°maras detectadas: ${devs.length}\n`;
      devs.forEach((d,i)=> txt += `- [${i}] ${d.label || '(sin etiqueta)'}\n`);
      cont.textContent = txt;
      cont.style.whiteSpace = 'pre-wrap';
      cont.style.color = '#cfe7ff';
    } catch (e) {
      showError(`Test fall√≥: ${e.name || ''} ${e.message || e}`);
    }
  }

  // Eventos
  document.getElementById('btnScan').onclick = startScanner;
  document.getElementById('btnStop').onclick = stopScanner;
  document.getElementById('btnTest').onclick = testCamera;
  document.getElementById('btnBuscar').onclick = async () => {
    const code = document.getElementById('eanInput').value.trim();
    if (code) await lookupAndRender(code);
  };
</script>


</body>
</html>



