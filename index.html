<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PrecioReal ¬∑ Escanea y abre en Amazon</title>
  <meta name="description" content="Escanea EAN/ISBN/UPC, encuentra el ASIN y abre la ficha en Amazon con tu enlace de afiliado.">
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#0b0f14">
  <style>
    :root{ --bg:#0b0f14; --panel:#121824; --text:#e7edf7; --muted:#a8b3c7; --brand:#3aa1ff; --brand2:#1e78d5; --bd:#1a2434; --ok:#9fe29f; --bad:#ffb3b3; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:820px;margin:0 auto;padding:16px}
    header{display:flex;align-items:center;gap:12px;padding:16px 0;border-bottom:1px solid var(--bd)}
    .logo{width:40px;height:40px;border-radius:10px;display:grid;place-items:center;background:linear-gradient(135deg,var(--brand),#7cc8ff);color:#041423;font-weight:900}
    h1{font-size:18px;margin:0}.muted{color:var(--muted)}
    .panel{background:var(--panel);border:1px solid var(--bd);border-radius:14px;padding:14px;margin:16px 0}
    .panel h2{margin:0 0 10px 0;font-size:16px}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:12px 16px;border:0;border-radius:12px;cursor:pointer;background:linear-gradient(180deg,var(--brand),var(--brand2));color:#06121f;font-weight:800}
    .btn.secondary{background:#182339;color:var(--text);border:1px solid #223352}
    .btn.ghost{background:transparent;border:1px dashed #2a3a5a;color:#9bb4d9}
    .btn[disabled]{opacity:.5;cursor:not-allowed}
    .row{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
    .row input{flex:1;min-width:180px;padding:12px;border-radius:12px;border:1px solid #223352;background:#0c1322;color:#e7edf7}
    #scanner{position:relative;aspect-ratio:3/2;background:#0d1423;border:1px dashed #223352;border-radius:12px;display:grid;place-items:center;overflow:hidden;margin-top:12px}
    #scanner video{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
    #overlay{position:absolute;left:8px;right:8px;bottom:8px;background:rgba(0,0,0,.45);border:1px solid #223352;border-radius:8px;padding:6px 8px;font-size:12px;color:#cfe7ff;white-space:pre-line}
    .card{display:grid;grid-template-columns:88px 1fr;gap:12px;align-items:center;background:#0d1423;border:1px solid var(--bd);border-radius:12px;padding:12px}
    .thumb{width:88px;height:88px;border-radius:10px;overflow:hidden;background:#101a2c;display:grid;place-items:center}
    .thumb img{width:100%;height:100%;object-fit:cover}
    .title{font-weight:700;line-height:1.25}
    .cta{margin-top:8px;display:flex;flex-wrap:wrap;gap:8px}
    .link{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:10px;background:#182339;border:1px solid #223352;color:#e7edf7;text-decoration:none}
    .link.disabled{opacity:.5;pointer-events:none}
    .link.big{font-size:18px;font-weight:900;padding:14px 16px;border-width:2px;width:100%;justify-content:center;min-height:48px}
    .hint{font-size:12px;color:#9bb4d9;margin-top:6px}
    footer{margin:18px 0 8px;border-top:1px solid var(--bd);padding-top:12px;color:#a8b3c7;font-size:0.9rem;line-height:1.35}

    /* Listas: √∫ltimos y favoritos */
    .list-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:10px}
    .mini{position:relative;display:grid;grid-template-columns:72px 1fr;gap:10px;align-items:center;background:#0d1423;border:1px solid var(--bd);border-radius:10px;padding:10px}
    .mini .thumb{width:72px;height:72px;border-radius:8px}
    .mini .title{font-size:13px;font-weight:700;max-height:2.6em;overflow:hidden}
    .mini .muted{font-size:12px}
    .mini .actions{display:flex;gap:6px;margin-top:8px;flex-wrap:wrap}
    .banner{display:flex;justify-content:center;align-items:center;width:100%;padding:12px 14px;border-radius:10px;background:#182339;border:1px solid #223352;color:#e7edf7;text-decoration:none;font-size:15px;font-weight:900;min-height:48px}
    .pvpLineMini{font-size:16px;font-weight:900;margin-top:8px;color:#cfe2ff}
    /* invertidos: ‚úï a la izquierda, ‚≠ê a la derecha (m√°s grande) */
    .icon-btn{position:absolute;top:6px;left:6px;background:#172033;border:1px solid #284066;color:#c9d9f2;width:24px;height:24px;line-height:22px;text-align:center;border-radius:8px;cursor:pointer;font-weight:900}
    .star{position:absolute;top:6px;right:6px;background:#172033;border:1px solid #284066;color:#f6e08f;width:36px;height:36px;line-height:34px;text-align:center;border-radius:12px;cursor:pointer;font-weight:900;font-size:20px}
    .star.off{color:#b0b0b0}
    .empty{color:#a8b3c7;font-size:13px}
    .bar{display:flex;justify-content:space-between;align-items:center;margin:8px 0 4px 0}
    .bar .title{font-size:14px;font-weight:800}
    .ok{color:var(--ok)} .bad{color:var(--bad)}
    .notePvp{font-size:14px;color:#b9c9e6;margin-top:6px;font-weight:800}
    .tipRecents{margin-top:10px;color:#9bb4d9;font-size:12px}

    /* Botones toggle (sonido/vibraci√≥n) */
    .toggles{display:flex;gap:8px;flex-wrap:wrap}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo">PR</div>
      <div>
        <h1>PrecioReal</h1>
        <div class="muted">Escanea un producto y abre su ficha en Amazon</div>
      </div>
    </header>

    <section class="panel">
      <b>Escanear con la c√°mara</b>
      <div id="scanner"><div id="overlay">Pulsa ‚ÄúIniciar esc√°ner‚Äù y permite la c√°mara</div></div>
      <div class="row">
        <button class="btn" id="btnScan">Iniciar esc√°ner</button>
        <button class="btn secondary" id="btnStop">Parar</button>
        <button class="btn secondary" id="btnSwap">Cambiar c√°mara</button>
        <button class="btn secondary" id="btnTorch">Linterna</button>
        <button class="btn secondary" id="btnTest">Test c√°mara</button>
        <button class="btn secondary" id="btnBatch">A√±adir por lote</button>
      </div>
      <div class="row toggles">
        <button class="btn secondary" id="btnToggleSound">Sonido: ON</button>
        <button class="btn secondary" id="btnToggleVibra">Vibraci√≥n: ON</button>
      </div>
      <div class="row">
        <input id="imgInput" type="file" accept="image/*" style="display:none">
        <button class="btn secondary" id="btnUpload">Subir foto (leer c√≥digo)</button>
      </div>
      <div class="hint">Si la c√°mara no abre, puedes subir una foto del c√≥digo o introducir el EAN manualmente.</div>
    </section>

    <section class="panel">
      <b>O introduce el c√≥digo (EAN/ISBN/UPC)</b>
      <div class="row">
        <input id="eanInput" inputmode="numeric" pattern="[0-9]*" placeholder="Ej.: 9788491296014" />
        <button class="btn secondary" id="btnBuscar">Buscar</button>
      </div>
      <div class="hint" id="eanHint"></div>
    </section>

    <section class="panel" id="resultado" style="display:none">
      <div class="card">
        <div class="thumb" id="thumb">‚Äî</div>
        <div>
          <div class="title" id="title">‚Äî</div>
          <div class="muted" id="category">‚Äî</div>
          <!-- L√≠nea vs tu PVP -->
          <div class="notePvp" id="userPvpLine" aria-live="polite"></div>
          <div class="cta">
            <button class="btn secondary" id="btnPvp">üíæ Guardar tu precio</button>
            <button class="btn secondary" id="btnPvpDel">üóë Borrar precio</button>
          </div>
          <!-- Bot√≥n grande de Amazon DEBAJO del PVP -->
          <a class="link big disabled" id="amazonLink" target="_self" rel="nofollow sponsored noopener">
            üõí Ver en Amazon
          </a>
        </div>
      </div>
    </section>

    <!-- √öltimos escaneados -->
    <section class="panel" id="panelRecents">
      <div class="bar">
        <div class="title">üïò √öltimos escaneados</div>
        <button class="btn ghost" id="btnClearRecents">Vaciar lista</button>
      </div>
      <div id="recents" class="list-grid"></div>
      <div id="recentsEmpty" class="empty" style="display:none">Aqu√≠ ver√°s tus √∫ltimos escaneos.</div>
      <!-- Consejo AL FINAL del panel -->
      <div id="tipRecents" class="tipRecents">Consejo: A√±√°delo en tu carrito de Amazon para no perderlo.</div>
    </section>

    <!-- Favoritos -->
    <section class="panel" id="panelFavs">
      <div class="bar">
        <div class="title">Favoritos</div>
        <button class="btn ghost" id="btnClearFavs">Vaciar favoritos</button>
      </div>
      <div id="favs" class="list-grid"></div>
      <div id="favsEmpty" class="empty" style="display:none">‚≠ê A√±ade los productos que quieras guardar.</div>
    </section>

    <!-- Footer con la divulgaci√≥n obligatoria -->
    <footer>
      En calidad de Afiliado de Amazon, obtengo ingresos por las compras adscritas que cumplen los requisitos aplicables.
    </footer>
  </div>

  <!-- Modal de lote -->
  <div class="modal" id="batchModal" aria-hidden="true">
    <div class="box">
      <h3>A√±adir por lote</h3>
      <p class="muted" style="margin:4px 0 10px">Pega c√≥digos separados por salto de l√≠nea, espacios o comas. Acepta EAN-13, UPC-A (12) y EAN-8. Se procesar√°n en orden.</p>
      <textarea id="batchCodes" placeholder="Ejemplo:
9788491296014
740617300253
8715946725963"></textarea>
      <div class="actions">
        <button class="btn secondary" id="batchCancel">Cancelar</button>
        <button class="btn" id="batchRun">Procesar</button>
      </div>
    </div>
  </div>

  <script>
  (function(){
    'use strict';

    // ---------- helpers ----------
    const $ = id => document.getElementById(id);
    const note = (m)=>{ const o=$('overlay'); if(o){o.textContent=m;o.style.display='block';} };
    const hideNote = ()=>{ const o=$('overlay'); if(o) o.style.display='none'; };
    const ttlSec = 1800; // 30 min cache local
    const MAX_RECENTS = 20;
    const K_RECENTS = 'pr-recent-v1';
    const K_FAVS = 'pr-favs-v1';
    const K_SETTINGS = 'pr-settings-v1';

    function loadSettings(){ try{ return JSON.parse(localStorage.getItem(K_SETTINGS)||'{}')||{}; }catch(_){ return {}; } }
    function saveSettings(s){ try{ localStorage.setItem(K_SETTINGS, JSON.stringify(s)); }catch(_){ } }
    let settings = Object.assign({ noSound:false, noVibra:false }, loadSettings());

    function renderToggles(){
      $('btnToggleSound').textContent = 'Sonido: ' + (settings.noSound ? 'OFF' : 'ON');
      $('btnToggleVibra').textContent = 'Vibraci√≥n: ' + (settings.noVibra ? 'OFF' : 'ON');
    }

    function beep(){
      try{
        if (!settings.noSound){
          const ctx=new (window.AudioContext||window.webkitAudioContext)();
          const o=ctx.createOscillator(); const g=ctx.createGain();
          o.frequency.value=880; g.gain.value=0.1; o.connect(g).connect(ctx.destination);
          o.start(); setTimeout(()=>{o.stop();ctx.close();},120);
        }
      }catch(_){}
      try{
        if (!settings.noVibra){ navigator.vibrate && navigator.vibrate(80); }
      }catch(_){}
    }
    const fmtMoney = (n)=> (isFinite(n)? (Number(n).toFixed(2).replace('.',',')) : '');

    // --------- Validaci√≥n EAN/UPC ----------
    function ean13Valid(s){
      s = String(s).replace(/[^0-9]/g,'');
      if (s.length !== 13) return false;
      const d = s.split('').map(n=>+n); const check=d[12];
      let sum=0; for(let i=0;i<12;i++) sum += d[i] * (i%2===0?1:3);
      return ((10 - (sum % 10)) % 10) === check;
    }
    function ean8Valid(s){
      s = String(s).replace(/[^0-9]/g,'');
      if (s.length !== 8) return false;
      const d = s.split('').map(n=>+n); const check=d[7];
      let sum=0; for(let i=0;i<7;i++) sum += d[i]*(i%2===0?3:1);
      return ((10 - (sum % 10)) % 10) === check;
    }
    function upcAValid(s){
      s = String(s).replace(/[^0-9]/g,'');
      if (s.length !== 12) return false;
      return ean13Valid('0'+s);
    }
    function validCode(code){
      const s = String(code).replace(/[^0-9]/g,'');
      if (s.length === 13) return { ok: ean13Valid(s), type:'EAN-13' };
      if (s.length === 8)  return { ok: ean8Valid(s),  type:'EAN-8'  };
      if (s.length === 12) return { ok: upcAValid(s),  type:'UPC-A'  };
      return { ok:false, type:'unknown' };
    }
    function setEanHint(msg, ok){
      const el = $('eanHint'); el.textContent = msg || '';
      el.style.color = ok ? '#9fe29f' : '#ffb3b3';
    }

    // --------- Cache local m√≠nima (respuesta lookup) ----------
    function cacheGet(ean){
      try{
        const raw = localStorage.getItem('pr-cache-'+ean);
        if(!raw) return null;
        const o = JSON.parse(raw);
        if (!o || !o.t || !o.d) return null;
        if ((Date.now()-o.t)/1000 > ttlSec) return null;
        return o.d;
      }catch(_){ return null; }
    }
    function cacheSet(ean, data){
      try{ localStorage.setItem('pr-cache-'+ean, JSON.stringify({ t: Date.now(), d: data })); }catch(_){}
    }

    // --------- Storage listas (√∫ltimos y favoritos) ----------
    function loadList(key){ try{ return JSON.parse(localStorage.getItem(key)||'[]')||[]; }catch(_){ return []; } }
    function saveList(key, arr){ try{ localStorage.setItem(key, JSON.stringify(arr)); }catch(_){ } }

    function getFromAnyList(id){
      const a = loadList(K_RECENTS).find(x=>x.id===id);
      if (a) return a;
      return loadList(K_FAVS).find(x=>x.id===id) || null;
    }

    function normalizeItem(ean, resp){
      const p = resp?.product||{};
      const m = resp?.meta||{};
      const id = m.asin || ean || p.asin || p.id || (p.affiliateLink||'').split('/api/go/')[1]?.split('?')[0] || null;
      // traer PVP previo si existe
      const prev = getFromAnyList(id) || {};
      return {
        id, ean: ean||null, asin: m.asin||null, domain: m.domain||null,
        title: p.title||('C√≥digo '+(ean||'desconocido')),
        image: p.image||null,
        category: p.category||'',
        affiliateLink: p.affiliateLink||null,
        userPrice: prev.userPrice||null,
        userPriceAt: prev.userPriceAt||null,
        ts: Date.now()
      };
    }

    function addRecent(item){
      if (!item || !item.id) return;
      const arr = loadList(K_RECENTS);
      const idx = arr.findIndex(x=>x.id===item.id);
      if (idx>=0) arr.splice(idx,1);
      arr.unshift(item);
      if (arr.length>MAX_RECENTS) arr.length = MAX_RECENTS;
      saveList(K_RECENTS, arr);
      log('recent-add', { id:item.id, asin:item.asin, ean:item.ean });
      renderRecents();
    }

    function updateItemPvp(id, pvp){
      const apply = (key)=>{
        const arr = loadList(key);
        const i = arr.findIndex(x=>x.id===id);
        if (i>=0){ arr[i].userPrice = pvp; arr[i].userPriceAt = (pvp!=null)? Date.now(): null; saveList(key, arr); }
      };
      apply(K_RECENTS); apply(K_FAVS);
      renderRecents(); renderFavs();
    }

    function removeRecent(id){
      const arr = loadList(K_RECENTS).filter(x=>x.id!==id);
      saveList(K_RECENTS, arr);
      log('recent-remove', { id });
      renderRecents();
    }
    function clearRecents(){ saveList(K_RECENTS, []); log('recent-clear', {}); renderRecents(); }

    function isFav(id){ return loadList(K_FAVS).some(x=>x.id===id); }
    function toggleFav(item){
      if (!item || !item.id) return;
      const arr = loadList(K_FAVS);
      const idx = arr.findIndex(x=>x.id===item.id);
      if (idx>=0){ arr.splice(idx,1); log('fav-remove', { id:item.id }); }
      else { arr.unshift(item); log('fav-add', { id:item.id }); }
      saveList(K_FAVS, arr); renderFavs(); renderRecents();
    }
    function clearFavs(){ saveList(K_FAVS, []); log('fav-clear', {}); renderFavs(); renderRecents(); }

    function openAmazon(href, source, id){
      if (!href) return;
      log(source+'-click', { id });
      location.href = href; // _self para evitar bloqueos
    }

    function tsToText(ts){
      try{
        if(!ts) return '';
        const d = new Date(ts);
        const dd = String(d.getDate()).padStart(2,'0');
        const mm = String(d.getMonth()+1).padStart(2,'0');
        const hh = String(d.getHours()).padStart(2,'0');
        const min = String(d.getMinutes()).padStart(2,'0');
        return `${dd}/${mm} ${hh}:${min}`;
      }catch(_){ return ''; }
    }

    function renderList(containerId, emptyId, arr, source){
      const el = $(containerId), empty = $(emptyId);
      if (!arr.length){ el.innerHTML=''; empty.style.display='block'; return; }
      empty.style.display='none';
      el.innerHTML = arr.map(item=>{
        const safeTitle = (item.title||'Producto').replace(/</g,'&lt;');
        const img = item.image ? `<img alt="Imagen" src="${item.image}">` : '‚Äî';
        const starOn = isFav(item.id);
        const disabled = item.affiliateLink ? '' : 'disabled';
        const pvpTxt = (item.userPrice!=null) ? `vs tu PVP: ${fmtMoney(item.userPrice)} ‚Ç¨` : '';
        return `
          <div class="mini" data-id="${item.id}">
            <div class="icon-btn" title="Quitar" data-action="remove">‚úï</div>
            <div class="star ${starOn?'':'off'}" title="${starOn?'Quitar de favoritos':'A√±adir a favoritos'}" data-action="star">‚òÖ</div>
            <div class="thumb">${img}</div>
            <div>
              <div class="title">${safeTitle}</div>
              <div class="muted">${item.category||'‚Äî'}</div>
              <div class="actions">
                <a class="banner ${disabled}" href="${item.affiliateLink||'#'}" data-action="open">üõí Ver en Amazon</a>
              </div>
              ${pvpTxt ? `<div class="pvpLineMini" data-action="price" title="Toca para editar">${pvpTxt}</div>` : ``}
            </div>
          </div>
        `;
      }).join('');

      // Delegaci√≥n de eventos
      el.querySelectorAll('.mini').forEach(card=>{
        const id = card.getAttribute('data-id');
        const item = arr.find(x=>x.id===id);
        card.addEventListener('click', (ev)=>{
          const act = ev.target?.getAttribute?.('data-action');
          if (!act) return;
          ev.preventDefault(); ev.stopPropagation();
          if (act==='remove'){ 
            source==='recents' ? removeRecent(id)
              : (saveList(K_FAVS, loadList(K_FAVS).filter(x=>x.id!==id)), log('fav-remove',{id}), renderFavs(), renderRecents());
          }
          if (act==='star'){ toggleFav(item); }
          if (act==='open'){ openAmazon(item.affiliateLink, source, id); }
          if (act==='price'){ askAndSavePvp(id); } // editar tocando el texto
        }, { passive:false });
      });
    }

    function renderRecents(){ renderList('recents','recentsEmpty', loadList(K_RECENTS), 'recent'); }
    function renderFavs(){ renderList('favs','favsEmpty', loadList(K_FAVS), 'fav'); }

    // --------- Logging simple ----------
    async function log(evt, data){
      try {
        await fetch('/api/log', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ evt, data, t: Date.now() }) });
      } catch(_){}
    }

    function setAmazonLink(href){
      const a = $('amazonLink');
      if (href){ a.href = href; a.classList.remove('disabled'); }
      else { a.href = '#'; a.classList.add('disabled'); }
    }

    function renderUserPvpLine(item){
      const line = $('userPvpLine');
      if (!line) return;
      if (item?.userPrice!=null){
        line.textContent = `vs tu PVP: ${fmtMoney(item.userPrice)} ‚Ç¨ (anotado ${tsToText(item.userPriceAt)}) ‚Äî Solo se guarda en tu dispositivo.`;
      } else {
        line.textContent = '';
      }
    }

    function renderResult(ok, p, ean, meta){
      p=p||{}; ean=ean||'';
      const box=$('resultado'), thumb=$('thumb'), title=$('title'), cat=$('category');
      if(!ok){
        box.style.display='block';
        thumb.textContent='‚Äî';
        title.textContent = 'No encontrado para ' + ean;
        cat.textContent = '‚Äî';
        setAmazonLink(null);
        renderUserPvpLine(null);
        return;
      }
      thumb.innerHTML = p.image ? '<img alt="Imagen" src="'+p.image+'">' : '‚Äî';
      title.textContent = p.title || ('C√≥digo '+ean);
      cat.textContent = p.category || '‚Äî';
      setAmazonLink(p.affiliateLink || null);
      box.style.display='block';
      box.scrollIntoView({behavior:'smooth', block:'start'});

      // A√±adir a "√öltimos"
      const item = normalizeItem(ean, { product:p, meta:meta||{} });
      addRecent(item);
      renderUserPvpLine(item);
      // vincular botones PVP al item actual
      $('btnPvp').onclick = ()=> askAndSavePvp(item.id);
      $('btnPvpDel').onclick = ()=> { updateItemPvp(item.id, null); renderUserPvpLine({}); };
    }

    function askAndSavePvp(id){
      const old = getFromAnyList(id);
      const pre = (old && old.userPrice!=null) ? String(old.userPrice).replace('.',',') : '';
      const v = prompt('Introduce tu precio (ej. 12,99):', pre);
      if (v===null) return;
      const num = Number(String(v).replace(',','.').replace(/[^\d.]/g,''));
      if (!isFinite(num)){ alert('Precio no v√°lido'); return; }
      const n = Math.max(0, num);
      updateItemPvp(id, n);
      const nowItem = getFromAnyList(id);
      if (nowItem) renderUserPvpLine(nowItem);
      log('user-price-save', { id, price:n });
    }

    async function lookupAndRender(ean){
      const cached = cacheGet(ean);
      if (cached){ renderResult(cached.success, cached.product, ean, cached.meta); log('cache-hit', { ean }); return; }
      try{
        const r = await fetch('/api/lookup?ean='+encodeURIComponent(ean));
        const d = await r.json();
        cacheSet(ean, d);
        renderResult(d && d.success, d && d.product, ean, d && d.meta);
        log('lookup', { ean, success: !!(d && d.success) });
      } catch(e){
        note('No se pudo consultar el backend.');
        renderResult(false, {}, ean, {});
        log('lookup-error', { ean, err: String(e) });
      }
    }

    // ---------- ZXing + c√°mara ----------
    let reader=null, currentStream=null, cams=[], camIndex=0, torchOn=false;

    function stopScanner(){
      try{ reader&&reader.reset&&reader.reset(); }catch(_){}
      try{ currentStream&&currentStream.getTracks().forEach(t=>t.stop()); }catch(_){}
      currentStream=null; note('Esc√°ner detenido'); torchOn=false;
    }

    async function listCams(){
      const devs = await navigator.mediaDevices.enumerateDevices();
      cams = devs.filter(d=>d.kind==='videoinput');
      if (!cams.length) return null;
      const back = cams.find(d=>/back|rear|environment|atr√°s|tr√°s/i.test(d.label||'')) || cams[cams.length-1];
      camIndex = Math.max(cams.findIndex(d=>d.deviceId===back.deviceId),0);
      return cams[camIndex]?.deviceId || null;
    }

    async function openStream(deviceId){
      try {
        return deviceId
          ? await navigator.mediaDevices.getUserMedia({ video:{ deviceId:{ exact:deviceId } }, audio:false })
          : await navigator.mediaDevices.getUserMedia({ video:{ facingMode:{ ideal:'environment' } }, audio:false });
      } catch(_){
        return await navigator.mediaDevices.getUserMedia({ video:true, audio:false });
      }
    }

    function loadZXing(){
      if (window.ZXingBrowser || window.ZXing) return Promise.resolve(true);
      return new Promise(resolve=>{
        const s=document.createElement('script');
        s.src='/api/zxing.js';
        s.async=true;
        s.onload=()=>resolve(!!(window.ZXingBrowser||window.ZXing));
        s.onerror=()=>resolve(false);
        document.head.appendChild(s);
      });
    }

    async function toggleTorch(){
      const track = currentStream?.getVideoTracks?.()[0];
      const caps = track?.getCapabilities?.();
      if (!track || !caps || !caps.torch) { note('Este dispositivo no soporta linterna.'); return; }
      try {
        torchOn = !torchOn;
        await track.applyConstraints({ advanced: [{ torch: torchOn }] });
        note(torchOn ? 'Linterna: ON' : 'Linterna: OFF');
        setTimeout(hideNote, 800);
      } catch(e) { note('No se pudo cambiar la linterna.'); }
    }

    async function startScanner(){
      note('Cargando ZXing‚Ä¶');
      const ok = await loadZXing();
      const ZX = window.ZXingBrowser || window.ZXing || null;
      const Reader = ZX && ZX.BrowserMultiFormatReader ? ZX.BrowserMultiFormatReader : null;
      if (!ok || !Reader) { note('ZXing no disponible. Usa la b√∫squeda manual.'); return; }

      try{
        const r = await fetch('/api/zxing.js', { cache:'no-store' });
        log('engine', { header:r.headers.get('X-Precioreal-ZXing') });
      }catch(_){}

      note('Pidiendo permiso de c√°mara‚Ä¶');
      try {
        const prov = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:{ ideal:'environment' } }, audio:false });
        prov.getTracks().forEach(t=>t.stop());
      } catch(e) {
        if (e && (e.name==='NotAllowedError'||e.name==='PermissionDeniedError')) { note('Permiso denegado. Act√≠valo en los ajustes del navegador.'); log('perm-denied',{}); return; }
        if (e && (e.name==='NotFoundError'||e.name==='DevicesNotFoundError')) { note('No hay c√°mara disponible.'); log('no-camera',{}); return; }
      }

      const cont = $('scanner');
      const video = document.createElement('video');
      video.setAttribute('playsinline',''); video.setAttribute('autoplay',''); video.setAttribute('muted','');
      video.muted=true; video.playsInline=true;
      video.style.width='100%'; video.style.height='100%'; video.style.objectFit='cover';
      cont.replaceChildren(video, (function(){ const m=document.createElement('div'); m.id='overlay'; return m;})());

      const deviceId = await listCams();
      note('Abriendo c√°mara‚Ä¶');

      try {
        currentStream = await openStream(deviceId);
        video.srcObject = currentStream; await video.play();
        hideNote();
      } catch(e) {
        if (e && (e.name==='NotReadableError'||e.name==='TrackStartError')) note('Otra app est√° usando la c√°mara. Ci√©rrala y reintenta.');
        else note('No se pudo abrir la c√°mara. Prueba el modo manual.');
        log('open-fail', { err: e && (e.name||e.message) });
        return;
      }

      note('Escaneando‚Ä¶');
      const reader = new Reader();
      let justScanned=false;
      await reader.decodeFromVideoDevice(deviceId || null, video, async (result)=>{
        if (result && result.getText && !justScanned) {
          const raw = result.getText() || '';
          const code = raw.replace(/[^0-9Xx]/g,'');
          if (code) { justScanned=true; beep(); stopScanner(); await lookupAndRender(code); }
        }
      });
    }

    async function swapCamera(){
      const devs = await navigator.mediaDevices.enumerateDevices();
      cams = devs.filter(d=>d.kind==='videoinput');
      if (!cams.length) return;
      camIndex = (camIndex + 1) % cams.length;
      stopScanner();

      const cont = $('scanner');
      const video = document.createElement('video');
      video.setAttribute('playsinline',''); video.setAttribute('autoplay',''); video.setAttribute('muted','');
      video.muted=true; video.playsInline=true;
      video.style.width='100%'; video.style.height='100%'; video.style.objectFit='cover';
      cont.replaceChildren(video, (function(){ const m=document.createElement('div'); m.id='overlay'; return m;})());
      note('Cambiando de c√°mara‚Ä¶');

      try {
        const deviceId = cams[camIndex]?.deviceId || null;
        currentStream = await openStream(deviceId);
        video.srcObject = currentStream; await video.play();

        const ZX = window.ZXingBrowser || window.ZXing || null;
        const Reader = ZX && ZX.BrowserMultiFormatReader ? ZX.BrowserMultiFormatReader : null;
        if (!Reader) { note('ZXing no disponible.'); return; }

        const rdr = new Reader();
        let justScanned=false;
        note('Escaneando‚Ä¶');
        await rdr.decodeFromVideoDevice(deviceId || null, video, async (result)=>{
          if (result && result.getText && !justScanned) {
            const raw = result.getText()||'';
            const code = raw.replace(/[^0-9Xx]/g,'');
            if (code) { justScanned=true; beep(); stopScanner(); await lookupAndRender(code); }
          }
        });
      } catch(e){
        note('No se pudo abrir la c√°mara seleccionada.');
      }
    }

    // Subir imagen para leer c√≥digo
    $('btnUpload').addEventListener('click', ()=> $('imgInput').click());
    $('imgInput').addEventListener('change', async (ev)=>{
      const f = ev.target.files && ev.target.files[0];
      if (!f) return;
      try{
        const imgURL = URL.createObjectURL(f);
        const img = new Image();
        img.onload = async ()=>{
          try{
            if ('BarcodeDetector' in window) {
              const bmp = await createImageBitmap(img);
              const det = new BarcodeDetector({ formats:['ean_13','ean_8','upc_a','upc_e','code_128','code_39','qr_code'] });
              const codes = await det.detect(bmp);
              bmp.close && bmp.close();
              if (codes && codes.length) {
                const code = String(codes[0].rawValue||'').replace(/[^0-9Xx]/g,'');
                if (code){ beep(); await lookupAndRender(code); return; }
              }
              note('No se detect√≥ c√≥digo en la imagen.');
            } else {
              note('Este navegador no soporta lectura desde imagen.');
            }
          }catch(e){ note('Fallo al procesar la imagen.'); }
          URL.revokeObjectURL(imgURL);
        };
        img.src = imgURL;
      }catch(_){ note('No se pudo abrir la imagen.'); }
    });

    // Validaci√≥n al escribir EAN/UPC
    $('eanInput').addEventListener('input', ()=>{
      const s = $('eanInput').value.replace(/[^0-9]/g,'');
      if (!s) { setEanHint('', true); return; }
      const v = validCode(s);
      if (!v.ok) setEanHint('C√≥digo no v√°lido (longitud o checksum).', false);
      else setEanHint(`C√≥digo v√°lido (${v.type}).`, true);
    });

    // Botones principales
    $('btnScan').addEventListener('click', startScanner);
    $('btnStop').addEventListener('click', stopScanner);
    $('btnSwap').addEventListener('click', swapCamera);
    $('btnTorch').addEventListener('click', toggleTorch);

    // Test c√°mara
    $('btnTest').addEventListener('click', async ()=>{
      let txt='';
      if (navigator.permissions && navigator.permissions.query) {
        try { const p=await navigator.permissions.query({name:'camera'}); txt+='Permiso c√°mara: '+p.state+'\n'; } catch(_){}
      }
      try { const s=await navigator.mediaDevices.getUserMedia({video:true,audio:false}); s.getTracks().forEach(t=>t.stop()); txt+='getUserMedia: ‚úÖ OK\n'; } catch(e){ txt+='getUserMedia: ‚ùå '+(e.name||e.message)+'\n'; }
      const devs=await navigator.mediaDevices.enumerateDevices(); const list=devs.filter(d=>d.kind==='videoinput');
      txt+='C√°maras detectadas: '+list.length+'\n'; list.forEach((d,i)=> txt+='- ['+i+'] '+(d.label||'(sin etiqueta)')+'\n');
      const track=currentStream?.getVideoTracks?.()[0]; const caps=track?.getCapabilities?.()||{};
      if (caps && Object.keys(caps).length) {
        txt+='Capacidades: '+Object.keys(caps).join(', ')+'\n';
        txt+='Torch soportado: '+(caps.torch?'s√≠':'no')+'\n';
      }
      note(txt||'Test hecho');
    });

    // Buscar manual
    $('btnBuscar').addEventListener('click', async ()=>{
      const code = $('eanInput').value.replace(/[^0-9]/g,'');
      const v = validCode(code);
      if (!v.ok){ setEanHint('C√≥digo no v√°lido.', false); return; }
      await lookupAndRender(code);
    });

    // Toggles sonido/vibraci√≥n
    renderToggles();
    $('btnToggleSound').addEventListener('click', ()=>{
      settings.noSound = !settings.noSound; saveSettings(settings); renderToggles();
    });
    $('btnToggleVibra').addEventListener('click', ()=>{
      settings.noVibra = !settings.noVibra; saveSettings(settings); renderToggles();
    });

    // Lote
    function openBatch(){ $('batchModal').style.display='flex'; $('batchModal').setAttribute('aria-hidden','false'); $('batchCodes').focus(); }
    function closeBatch(){ $('batchModal').style.display='none'; $('batchModal').setAttribute('aria-hidden','true'); }
    $('btnBatch').addEventListener('click', openBatch);
    $('batchCancel').addEventListener('click', closeBatch);
    $('batchRun').addEventListener('click', async ()=>{
      const raw = $('batchCodes').value || '';
      const toks = raw.split(/[\s,;]+/).filter(Boolean);
      const codes=[];
      for (const t of toks){
        const s = String(t).replace(/[^0-9]/g,'');
        if (!s) continue;
        const v = validCode(s);
        if (v.ok) codes.push(s);
      }
      if (!codes.length){ alert('No hay c√≥digos v√°lidos.'); return; }
      closeBatch();
      for (let i=0;i<codes.length;i++){
        note(`Procesando lote ${i+1}/${codes.length}‚Ä¶`);
        await lookupAndRender(codes[i]);
      }
      note('Lote terminado'); setTimeout(hideNote, 1200);
    });

    // Controles de listas
    $('btnClearRecents').addEventListener('click', ()=>{
      if (confirm('¬øVaciar lista de √∫ltimos escaneados?')) clearRecents();
    });
    $('btnClearFavs').addEventListener('click', ()=>{
      if (confirm('¬øVaciar favoritos?')) clearFavs();
    });

    // Render inicial
    function renderRecents(){ renderList('recents','recentsEmpty', loadList(K_RECENTS), 'recent'); }
    function renderFavs(){ renderList('favs','favsEmpty', loadList(K_FAVS), 'fav'); }
    renderRecents(); renderFavs();
  })();
  </script>
</body>
</html>
