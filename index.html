<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>PrecioReal ¬∑ Escanea y abre en Amazon (E2 ‚Äì cuadrado centrado)</title>
  <meta name="description" content="Escanea EAN/UPC/ISBN, encuentra el ASIN y abre la ficha de Amazon con tu enlace de afiliado.">
  <meta name="theme-color" content="#0b0f14">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="manifest" href="/manifest.json">
  <link rel="apple-touch-icon" href="/icons/icon-192.png">
  <style>
    :root{ --bg:#0b0f14; --panel:#121824; --text:#e7edf7; --muted:#a8b3c7; --brand:#3aa1ff; --brand2:#1e78d5; --bd:#1a2434; --ok:#9fe29f; --bad:#ffb3b3; }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial; background:var(--bg); color:var(--text)}

    /* ===== AppBar (est√°tica, profesional) ===== */
    header.appbar{background:var(--panel);border-bottom:1px solid var(--bd);height:56px;padding:0 12px;display:flex;align-items:center;justify-content:space-between}
    .brand{display:flex;align-items:center;gap:10px}
    .brand .logo{width:28px;height:28px;border-radius:8px;background:#0f1726;border:1px solid var(--bd);display:block;object-fit:cover}
    .brand .title{font-weight:700;letter-spacing:.2px}
    .app-actions{display:flex;gap:8px}
    .btn{appearance:none;border:1px solid var(--bd);background:#182131;color:var(--text); padding:8px 10px;border-radius:10px;cursor:pointer}
    .btn.primary{background:linear-gradient(180deg,var(--brand),var(--brand2));border:none;color:#001225;font-weight:700}
    .btn.secondary{background:#162033}
    .btn.warn{background:#3a1c1c;border-color:#6b2a2a}
    .btn:active{transform:translateY(1px)}

    main{max-width:900px;margin:0 auto;padding:12px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .muted{color:var(--muted)}

    /* ===== Cards ===== */
    .cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px}
    .card{position:relative;background:var(--panel);border:1px solid var(--bd);border-radius:16px;overflow:hidden;display:flex;flex-direction:column}

    /* E2: cuadrado blanco centrado, tama√±o controlado */
    .cover{width:100%;aspect-ratio:1/1;background:#ffffff;display:flex;align-items:center;justify-content:center;padding:2px 2px 2px;overflow:hidden}
    .cover img{display:block;width:100%;height:100%;object-fit:contain;transform:scale(var(--fit,0.92));transform-origin:center} 

    .card .body{padding:12px;display:flex;flex-direction:column;gap:8px}
    .title{font-weight:600;font-size:.95rem;line-height:1.25rem}
    .cat{font-size:.8rem;color:var(--muted)}
    .row.actions{display:flex;gap:8px;margin-top:auto}
    .chip{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--bd);padding:4px 8px;border-radius:999px;font-size:.8rem;color:var(--muted)}
    .price{font-family:ui-monospace,Menlo,Consolas;font-size:.95rem}
    .btn.cta{min-height:46px;padding:10px 14px;font-weight:800;margin-left:auto}

    /* ===== Bot√≥n favorito (overlay) ===== */
    .fav-btn{position:absolute;top:8px;right:8px;width:40px;height:40px;border-radius:10px;border:1px solid var(--bd);background:#0f1726;display:grid;place-items:center;font-size:18px;cursor:pointer}
    .fav-btn[aria-pressed="true"]{background:#11233a;border-color:#2a4a7a;color:#ffd166}
    .fav-btn:focus-visible{outline:2px solid #3aa1ff;outline-offset:2px}

    /* ===== Tabs y contadores ===== */
    .tabs{display:flex;gap:8px;margin-top:10px}
    .tab{padding:8px 12px;border-radius:12px;border:1px solid var(--bd);cursor:pointer;color:var(--muted)}
    #tabComparar.tab{ border-color:#1e78d5 }
    #tabComparar.tab.active{ background:linear-gradient(180deg,var(--brand),var(--brand2)); color:#001225; font-weight:800 }
    #tabLista.tab{ border-color:#6b4dd6 }
    #tabLista.tab.active{ background:linear-gradient(180deg,#b59aff,#6b4dd6); color:#0b0720; font-weight:800 }
    .section-title{display:flex;align-items:center;justify-content:space-between;margin:16px 0 8px}
    .counter{font-size:.85rem;color:var(--muted)}

    .divider{height:1px;background:var(--bd);margin:12px 0}
    .flex{display:flex;align-items:center;gap:8px}

    footer{padding:40px 12px;color:var(--muted);text-align:center}
    .link{color:#9ecbff;text-decoration:none}

    /* ===== Panel de configuraci√≥n ===== */
    .opts-anchor{position:relative}
    .opts-anchor #btnOpts{ order:1; margin-left:auto }
    .opts-anchor #btnScan{ order:2 }
    .opts-anchor #optsPanel{ order:3; width:100% }
    .opts-panel{position:relative;width:100%;background:#10192b;border:1px solid var(--bd);border-radius:12px;box-shadow:0 12px 32px rgba(0,0,0,.35);margin-top:8px; overflow:hidden; max-height:0; transition:max-height .24s ease}
    .opts-panel.open{max-height:800px}
    .opts-inner{padding:12px;display:grid;gap:10px}
    .opts-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:8px}
    .opts-note{font-size:.85rem;color:var(--muted)}

    /* ===== C√°mara (rect√°ngulo) ===== */
    .cam-wrap{ margin-top:10px }
    .cam-frame{ position:relative; width:100%; aspect-ratio:16/9; max-height:34vh; margin:0 auto; background:#000; border:1px solid var(--bd); border-radius:16px; overflow:hidden }
    video#video{width:100%;height:100%;max-height:none;object-fit:cover;display:block;background:#000;border:0}
    #cameraControls{display:none;align-items:center;gap:10px;margin-top:8px}
    #zoomSlider{width:220px}

    /* ===== Toasts ===== */
    #toasts{position:fixed;left:50%;transform:translateX(-50%);bottom:16px;display:flex;flex-direction:column;gap:8px;z-index:9999;pointer-events:none}
    .toast{pointer-events:auto;display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:12px;border:1px solid var(--bd);background:#10192b;color:#fff;box-shadow:0 8px 24px rgba(0,0,0,.3)}
    .toast.success{border-color:#22553a;background:#0f2a1d;color:#a6f3b3}
    .toast.error{border-color:#5a2727;background:#2a0f0f;color:#ffbdbd}
    .toast .act{margin-left:6px;text-decoration:underline;cursor:pointer}

    /* Bot√≥n Esc√°ner: tama√±o medio (ligeramente mayor que las tabs) */
    #btnScan{ min-height:48px; padding:10px 14px; font-weight:900 }
    .btn.scan-on{ background:linear-gradient(180deg,#ffd84d,#ffb300); color:#1a1200; border:none; min-height:48px; padding:10px 14px; font-weight:900 }

    /* iOS hint */
    .ios-hint{background:#10192b;border:1px dashed var(--bd);color:#muted;margin:8px auto 0;max-width:900px;padding:8px 12px;border-radius:10px;font-size:.9rem;display:none}
    .ios-hint b{color:#e7edf7}

    @media (prefers-reduced-motion: reduce){ .opts-panel{transition:none} }
  </style>
</head>
<body>
  <!-- App bar est√°tica -->
  <header class="appbar" aria-label="Barra de la app">
    <div class="brand">
      <img class="logo" src="/icons/icon-192.png" alt="Logo" onerror="this.style.background='#122038'; this.src=''; this.outerHTML='<div class=\'logo\' style=\"display:grid;place-items:center;font-weight:800\">PR</div>'">
      <div class="title">PrecioReal</div>
    </div>
    <div class="app-actions">
      <button id="btnInstall" class="btn" aria-label="Instalar aplicaci√≥n" style="display:none">‚¨áÔ∏è Instalar</button>
    </div>
  </header>

  <div id="iosHint" class="ios-hint" role="note">En iPhone/iPad: abre <b>Compartir</b> y elige <b>‚ÄúA√±adir a pantalla de inicio‚Äù</b> para instalar la app.</div>

  <main>
    <!-- Controles superiores: Configuraci√≥n + Esc√°ner a la derecha -->
    <div class="row opts-anchor" style="margin-top:12px">
      <button id="btnOpts" class="btn secondary" aria-expanded="false" aria-controls="optsPanel" aria-label="Abrir configuraci√≥n">‚öôÔ∏è Configuraci√≥n</button>
      <button id="btnScan" class="btn primary">üì∑ Esc√°ner</button>

      <!-- Panel de configuraci√≥n -->
      <div id="optsPanel" class="opts-panel" role="region" aria-label="Opciones de configuraci√≥n">
        <div class="opts-inner">
          <div class="row">
            <input id="inputManual" class="btn grow" type="text" placeholder="Introducir c√≥digo manual" aria-label="C√≥digo manual">
            <button id="btnManualGo" class="btn">‚ûï A√±adir</button>
          </div>

          <div class="opts-grid">
            <button class="btn secondary" id="btnToggleSound">Sonido: ON</button>
            <button class="btn secondary" id="btnToggleVibra">Vibraci√≥n: ON</button>
            <button class="btn secondary" id="btnToggleContinuous">Esc√°ner continuo: ON</button>
            <button class="btn secondary" id="btnOpenInApp">Abrir en app: OFF</button>
            <button class="btn secondary" id="btnTorch">Linterna: OFF</button>
            <button class="btn secondary" id="btnTestCam">Test c√°mara</button>
          </div>

          <div class="opts-note">Consejo: activa ‚ÄúEsc√°ner continuo‚Äù para leer varios c√≥digos seguidos. ‚ÄúAbrir en app‚Äù usa el intent de Android si est√° disponible.</div>
        </div>
      </div>
    </div>

    <div class="cam-wrap">
      <div class="cam-frame">
        <video id="video" playsinline muted></video>
      </div>
    </div>

    <div id="cameraControls" class="row">
      <span class="muted">Zoom</span>
      <input type="range" id="zoomSlider" min="1" max="1" step="0.1" value="1">
      <span id="zoomVal" class="muted">1√ó</span>
      <span id="afBadge" class="chip" title="Auto-focus">AF auto</span>
    </div>

    <div class="tabs">
      <div id="tabComparar" class="tab active">Comparar</div>
      <div id="tabLista" class="tab">Favoritos</div>
    </div>

    <div id="viewComparar">
      <div class="section-title">
        <div class="flex"><span class="counter" id="countComparar">0 √≠tems</span></div>
        <div class="flex"><button id="btnVaciarLista" class="btn warn">üóëÔ∏è Vaciar lista</button></div>
      </div>
      <div class="cards" id="cardsComparar"></div>
    </div>

    <div id="viewLista" style="display:none">
      <div class="section-title">
        <div class="flex"><span class="counter" id="countLista">0 √≠tems</span></div>
        <div class="flex"><button id="btnMostrarComprados" class="btn">Ver comprados: OFF</button></div>
      </div>
      <div class="cards" id="cardsLista"></div>
    </div>

    <div class="divider"></div>
    <div class="muted">Cumplimiento Amazon Afiliados: no mostramos precios de Amazon; los datos de precio son manuales del usuario.</div>
  </main>

  <footer>
    <a class="link" href="/api/zxing.js" target="_blank" rel="noopener">ZXing local</a> ¬∑
    <a class="link" href="/api/lookup?ean=9788491296014" target="_blank" rel="noopener">Lookup test</a> ¬∑
    <a class="link" href="/api/go/B07ZDBT15M?d=9" target="_blank" rel="noopener">Go test</a>
  </footer>

  <div id="toasts" aria-live="polite" aria-atomic="true"></div>

  <script src="/api/zxing.js" defer></script>
  <script>
  const $ = sel => document.getElementById(sel);
  const sleep = ms => new Promise(r=>setTimeout(r,ms));
  const now = () => Date.now();

  function loadSettings(){ try { return JSON.parse(localStorage.getItem('pr-settings-v1')||'{}'); } catch(e){ return {}; } }
  function saveSettings(s){ localStorage.setItem('pr-settings-v1', JSON.stringify(s||{})); }

  let settings = Object.assign({ noSound:false, noVibra:false, continuous:true, openInApp:false }, loadSettings());
  function renderToggles(){
    $('btnToggleSound').textContent = 'Sonido: ' + (settings.noSound ? 'OFF' : 'ON');
    $('btnToggleVibra').textContent = 'Vibraci√≥n: ' + (settings.noVibra ? 'OFF' : 'ON');
    $('btnToggleContinuous').textContent = 'Esc√°ner continuo: ' + (settings.continuous ? 'ON' : 'OFF');
    $('btnOpenInApp').textContent = 'Abrir en app: ' + (settings.openInApp ? 'ON' : 'OFF');
  }
  function attachToggleEvents(){
    $('btnToggleSound').addEventListener('click', ()=>{ settings.noSound=!settings.noSound; saveSettings(settings); renderToggles(); });
    $('btnToggleVibra').addEventListener('click', ()=>{ settings.noVibra=!settings.noVibra; saveSettings(settings); renderToggles(); });
    $('btnToggleContinuous').addEventListener('click', ()=>{ settings.continuous=!settings.continuous; saveSettings(settings); renderToggles(); });
    $('btnOpenInApp').addEventListener('click', ()=>{ settings.openInApp=!settings.openInApp; saveSettings(settings); renderToggles(); });
  }

  // Panel de configuraci√≥n
  const btnOpts = $('btnOpts');
  const optsPanel = $('optsPanel');
  btnOpts.addEventListener('click', ()=>{
    const open = optsPanel.classList.toggle('open');
    btnOpts.setAttribute('aria-expanded', open ? 'true' : 'false');
  });
  document.addEventListener('click', (e)=>{
    if(!optsPanel.classList.contains('open')) return;
    const within = e.target.closest('.opts-anchor, .opts-panel');
    if(!within){ optsPanel.classList.remove('open'); btnOpts.setAttribute('aria-expanded','false'); }
  });

  renderToggles(); attachToggleEvents();

  let scanning = false, stream = null, lastScanAt = 0, torchOn = false, wakeLock = null, currentTrack = null;
  let detector = ('BarcodeDetector' in window) ? new BarcodeDetector({ formats:['ean_13','ean_8','upc_a','upc_e','code_128'] }) : null;
  let autostopTimer = null;

  const codeCooldown = new Map(); // code -> ts
  const burstBuffer = [];         // {code,t}
  let lastBurstNoticeAt = 0;

  function loadArr(key){ try{return JSON.parse(localStorage.getItem(key)||'[]')}catch(e){return[]} }
  function saveArr(key, val){ localStorage.setItem(key, JSON.stringify(val||[])); }
  let recientes = loadArr('pr-recent-v1');
  let favoritos = loadArr('pr-favs-v1');
  let showComprados = false;

  function vibrate(ms=40){ try{ if(!settings.noVibra && navigator.vibrate) navigator.vibrate(ms); }catch(e){} }
  async function beep(){ if(settings.noSound) return; try{ const ctx = new (window.AudioContext||window.webkitAudioContext)(); const o = ctx.createOscillator(); const g = ctx.createGain(); o.connect(g); g.connect(ctx.destination); o.type='sine'; o.frequency.value=880; g.gain.value=0.02; o.start(); setTimeout(()=>{ o.stop(); ctx.close(); },120); }catch(e){} }

  function showToast({message, type='info', timeout=2500, actionText='', onAction=null}={}){
    const root = $('toasts'); const el = document.createElement('div');
    el.className = 'toast' + (type==='success' ? ' success' : type==='error' ? ' error' : '');
    el.innerHTML = `<span>${message}</span>` + (actionText ? ` <span class="act">${actionText}</span>` : '');
    root.appendChild(el);
    let timer = setTimeout(()=>{ el.remove(); }, timeout);
    if(actionText && onAction){ el.querySelector('.act').addEventListener('click', ()=>{ clearTimeout(timer); onAction(); el.remove(); }); }
  }

  function switchTab(name){
    const isComparar = name==='comparar';
    $('tabComparar').classList.toggle('active', isComparar);
    $('tabLista').classList.toggle('active', !isComparar);
    $('viewComparar').style.display = isComparar?'block':'none';
    $('viewLista').style.display = isComparar?'none':'block';
    renderAll();
  // Ajuste visual para que ninguna imagen quede "gigante" en E1
  function tuneCardImages(){
    const adjust=(img)=>{
      const w=img.naturalWidth||0,h=img.naturalHeight||0; if(!w||!h) return;
      const r=h/w; let fit=0.92; // base con aire
      if(r>1.35||r<0.75) fit=0.96; // muy vertical u horizontal: un poco m√°s grande
      else fit=0.88; // casi cuadradas: un poco m√°s peque√±as para evitar sensaci√≥n gigante
      img.style.setProperty('--fit', String(fit));
    };
    document.querySelectorAll('.card .cover img').forEach(img=>{ img.complete?adjust(img):img.addEventListener('load',()=>adjust(img),{once:true}); });
  }
  tuneCardImages();
  }
  $('tabComparar').addEventListener('click', ()=>switchTab('comparar'));
  $('tabLista').addEventListener('click', ()=>switchTab('lista'));

  function isFav(id){ return favoritos.some(f=>f.id===id); }

  function itemCardHTML(item, inList=false){
    const img = item.image ? `<img src="${item.image}" alt="">` : '';
    const favPressed = isFav(item.id) ? 'true' : 'false';
    const price = item.userPrice!=null ? `<div class="price">PvP Tienda: ${item.userPrice.toFixed(2)} ‚Ç¨</div>` : '';
    const bought = inList ? `<span class="chip">Comprado: <input type="checkbox" ${item.completed?'checked':''} data-action="toggle-comprado" data-id="${item.id}"></span>` : '';
    return `
      <div class="card" data-id="${item.id}">
        <button class="fav-btn" data-action="fav-toggle" data-id="${item.id}" aria-pressed="${favPressed}" title="${isFav(item.id)?'Quitar de favoritos':'A√±adir a favoritos'}">${isFav(item.id)?'‚òÖ':'‚òÜ'}</button>
        <div class="cover">${img || '<div style="padding:32px;color:#4a5c7a;text-align:center">Sin imagen</div>'}</div>
        <div class="body">
          <div class="title">${escapeHtml(item.title||'Sin t√≠tulo')}</div>
          <div class="cat">${escapeHtml(item.category||'')}</div>
          ${price}
          <div class="row actions">
            <button class="btn" data-action="add-price" data-id="${item.id}">‚Ç¨ Precio</button>
            ${bought}
            <button class="btn primary cta" data-action="open" data-id="${item.id}">üõí Ver en Amazon</button>
          </div>
        </div>
      </div>`;
  }

  function renderAll(){
    $('cardsComparar').innerHTML = recientes.map(it=>itemCardHTML(it,false)).join('');
    $('countComparar').textContent = `${recientes.length} √≠tems`;
    const list = favoritos.filter(f=> showComprados ? true : !f.completed);
    $('cardsLista').innerHTML = list.map(it=>itemCardHTML(it,true)).join('');
    $('countLista').textContent = `${list.length} √≠tems`;
  }
  renderAll();

  // Click handling (incluye favorito con stopPropagation)
  document.addEventListener('click', (e)=>{
    const fav = e.target.closest('.fav-btn');
    if(fav){
      e.stopPropagation(); e.preventDefault();
      const id = fav.dataset.id; if(!id) return;
      const exists = favoritos.findIndex(x=>x.id===id);
      if(exists>=0){ favoritos.splice(exists,1); saveArr('pr-favs-v1', favoritos); }
      else{
        const base = recientes.find(x=>x.id===id) || favoritos.find(x=>x.id===id);
        if(base){ favoritos.unshift({...base}); saveArr('pr-favs-v1', favoritos); }
      }
      renderAll();
      return;
    }

    const btn = e.target.closest('button,span[data-action],input[type="checkbox"][data-action]'); if(!btn) return;
    const action = btn.dataset.action; const id = btn.dataset.id;

    if(action==='open' && id){ const item = recientes.find(x=>x.id===id) || favoritos.find(x=>x.id===id); if(item) openAmazonSmart(item); }

    if(action==='add-price' && id){
      const item = recientes.find(x=>x.id===id) || favoritos.find(x=>x.id===id); if(!item) return;
      const val = prompt('Precio manual (‚Ç¨, usa punto o coma):', item.userPrice!=null? String(item.userPrice):'');
      if(val!=null){ const n = Number(String(val).replace(',','.')); if(!isNaN(n)){ item.userPrice = Math.round(n*100)/100; item.userPriceAt = now(); persistItem(item); renderAll(); } }
    }

    if(action==='toggle-comprado' && id){
      const item = favoritos.find(x=>x.id===id); if(!item) return;
      item.completed = btn.checked; item.completedAt = item.completed ? now() : null; saveArr('pr-favs-v1', favoritos); renderAll();
    }
  });

  // Vaciar lista (solo Comparar)
  $('btnVaciarLista').addEventListener('click', ()=>{
    if(!recientes.length) return;
    if(confirm('¬øSeguro que quieres vaciar la lista de escaneados (Comparar)?')){
      recientes = []; saveArr('pr-recent-v1', recientes); renderAll();
      showToast({ message: 'Lista vaciada', type:'success', timeout:1500 });
    }
  });

  $('btnMostrarComprados').addEventListener('click', ()=>{ showComprados = !showComprados; $('btnMostrarComprados').textContent = 'Ver comprados: ' + (showComprados?'ON':'OFF'); renderAll(); });

  function persistItem(item){
    const i = recientes.findIndex(x=>x.id===item.id); if(i>=0){ recientes[i]=item; saveArr('pr-recent-v1', recientes); }
    const j = favoritos.findIndex(x=>x.id===item.id); if(j>=0){ favoritos[j]=item; saveArr('pr-favs-v1', favoritos); }
  }

  async function requestWakeLock(){ try{ if('wakeLock' in navigator){ wakeLock = await navigator.wakeLock.request('screen'); wakeLock.addEventListener('release', ()=>{}); } }catch(e){} }
  async function releaseWakeLock(){ try{ await wakeLock?.release(); }catch(e){} wakeLock = null; }
  document.addEventListener('visibilitychange', async ()=>{ if(document.visibilityState === 'visible' && scanning && wakeLock){ try{ wakeLock = await navigator.wakeLock.request('screen'); }catch(e){} } });

  const video = $('video');
  async function startScan(){
    if(scanning) return; scanning = true;
    $('btnScan').textContent = '‚õî Detener'; $('btnScan').classList.add('scan-on');
    try{
      stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'environment' }, audio:false });
      video.srcObject = stream; await video.play(); scheduleAutostop(); await requestWakeLock();
      currentTrack = stream.getVideoTracks()[0]; setupCameraControls(currentTrack).catch(()=>{});
      if(detector){ scanLoopBarcodeDetector(); } else { scanLoopZXing(); }
    }catch(e){
      scanning = false; $('btnScan').textContent = 'üì∑ Esc√°ner'; $('btnScan').classList.remove('scan-on'); alert('No se pudo iniciar la c√°mara.');
    }
  }
  function stopScan(){
    scanning = false; $('btnScan').textContent = 'üì∑ Esc√°ner'; $('btnScan').classList.remove('scan-on');
    try{ if(stream){ stream.getTracks().forEach(t=>t.stop()); } stream = null; currentTrack = null; }catch(e){}
    clearAutostop(); torchOff(); releaseWakeLock(); $('cameraControls').style.display = 'none';
  }
  $('btnScan').addEventListener('click', ()=> scanning ? stopScan() : startScan() );

  function scheduleAutostop(){ clearAutostop(); autostopTimer = setTimeout(()=>{ if(scanning) stopScan(); }, 10*60*1000); }
  function clearAutostop(){ if(autostopTimer){ clearTimeout(autostopTimer); autostopTimer=null; }}

  async function scanLoopBarcodeDetector(){
    while(scanning){
      try{
        const barcodes = await detector.detect(video);
        if(barcodes && barcodes.length){
          const code = sanitizeCode(barcodes[0].rawValue || ''); if(code) await onCodeDetected(code);
        }
      }catch(e){}
      await sleep(120);
    }
  }
  async function scanLoopZXing(){
    let ZX = window.ZXing || window['ZXing'];
    for(let i=0;i<50 && !ZX;i++){ await sleep(100); ZX = window.ZXing || window['ZXing']; }
    if(!ZX){ return; }
    const reader = new ZX.BrowserMultiFormatReader();
    try{
      await reader.decodeFromVideoDevice(null, video, async (result, err)=>{
        if(!scanning) return;
        if(result){
          const code = sanitizeCode(result.getText()); if(code) await onCodeDetected(code);
          if(!settings.continuous){ reader.reset(); }
        }
      });
    }catch(e){}
  }

  function sanitizeCode(raw){ if(!raw) return ''; return String(raw).replace(/[^0-9Xx]/g,'').toUpperCase(); }

  async function onCodeDetected(code){
    const t = now();
    const last = codeCooldown.get(code) || 0; if(t - last < 2000) return; codeCooldown.set(code, t);
    if(t - lastScanAt < 300) return; lastScanAt = t; scheduleAutostop();
    vibrate(30); beep();

    burstBuffer.push({ code, t }); for(let i=burstBuffer.length-1;i>=0;i--){ if(t - burstBuffer[i].t > 5000) burstBuffer.splice(i,1); }
    const distinct = new Set(burstBuffer.map(x=>x.code)).size;

    let item = await resolveEAN(code);
    if(item){
      const existing = recientes.find(x=>x.id===item.id);
      if(!existing){ recientes.unshift(item); saveArr('pr-recent-v1', recientes); }
      else { Object.assign(existing, item); saveArr('pr-recent-v1', recientes); }
      renderAll();
      showToast({ message: '‚úÖ Encontrado', type:'success', timeout:1500 });
    }else{
      showToast({ message: '‚ùå No encontrado', type:'error', timeout:1800 });
    }
    if(settings.continuous && distinct >= 3 && (t - lastBurstNoticeAt > 4000)){
      lastBurstNoticeAt = t;
      showToast({ message: `Procesados ${distinct}`, type: 'success', timeout: 4000, actionText: 'Ver', onAction: ()=> switchTab('comparar') });
    }
    if(!settings.continuous) stopScan();
  }

  async function resolveEAN(ean){
    const cacheKey = 'pr-cache-' + ean;
    try{ const cached = JSON.parse(localStorage.getItem(cacheKey)||'null'); if(cached && (now()-cached.t) < 30*60*1000){ return cached.item; } }catch(e){}
    try{
      const r = await fetch('/api/lookup?ean='+encodeURIComponent(ean), { cache:'no-store' });
      if(!r.ok) throw new Error('lookup http '+r.status);
      const data = await r.json();
      if(!data.success) { return null; }
      const prod = data.product||{}; const meta = data.meta||{}; const asin = meta.asin || ''; const domain = meta.domain || '9';
      const item = { id: asin || ean, ean, asin, domain, title: prod.title || ('EAN ' + ean), image: prod.image || null, category: prod.category || '',
        affiliateLink: prod.affiliateLink || ('/api/go/'+encodeURIComponent(asin)+'?d='+encodeURIComponent(domain)), userPrice: null, userPriceAt: null,
        tags: [], completed: false, completedAt: null, ts: now() };
      localStorage.setItem(cacheKey, JSON.stringify({ t:now(), item })); return item;
    }catch(err){ enqueueOffline(ean); return null; }
  }
  function enqueueOffline(ean){ const q = loadArr('pr-queue-v1'); q.push({ ean, t: now() }); saveArr('pr-queue-v1', q); }
  async function reprocesarCola(){ const q = loadArr('pr-queue-v1'); if(!q.length) return; const next = q.shift(); saveArr('pr-queue-v1', q); const item = await resolveEAN(next.ean); if(item){ if(!recientes.find(x=>x.id===item.id)){ recientes.unshift(item); saveArr('pr-recent-v1', recientes); renderAll(); } } setTimeout(reprocesarCola, 500); }
  window.addEventListener('online', reprocesarCola); reprocesarCola();

  $('btnManualGo').addEventListener('click', async ()=>{ const code = sanitizeCode($('inputManual').value); if(!code) return; const item = await resolveEAN(code); if(item){ if(!recientes.find(x=>x.id===item.id)){ recientes.unshift(item); saveArr('pr-recent-v1', recientes); renderAll(); } showToast({ message: '‚úÖ Encontrado', type:'success', timeout:1500 }); } else { showToast({ message: '‚ùå No encontrado', type:'error', timeout:1800 }); } });

  $('btnTorch').addEventListener('click', async ()=>{ if(!stream){ alert('Inicia el esc√°ner primero.'); return; } const track = stream.getVideoTracks()[0]; const caps = track.getCapabilities?.(); if(!caps || !('torch' in caps)){ alert('Este dispositivo/navegador no soporta linterna.'); return; } torchOn = !torchOn; try{ await track.applyConstraints({ advanced:[{ torch: torchOn }] }); $('btnTorch').textContent = 'Linterna: ' + (torchOn?'ON':'OFF'); }catch(e){ alert('No se pudo activar la linterna.'); } });

  $('btnTestCam').addEventListener('click', async ()=>{ try{ const s = await navigator.mediaDevices.getUserMedia({ video:true, audio:false }); s.getTracks().forEach(t=>t.stop()); alert('C√°mara OK'); }catch(e){ alert('Error c√°mara'); } });

  async function setupCameraControls(track){ try{ const caps = track.getCapabilities?.() || {}; const settingsV = track.getSettings?.() || {}; if(caps.focusMode && Array.isArray(caps.focusMode) && caps.focusMode.includes('continuous')){ try{ await track.applyConstraints({ advanced:[{ focusMode:'continuous' }] }); $('afBadge').style.display = 'inline-flex'; }catch(e){ $('afBadge').style.display = 'none'; } }else{ $('afBadge').style.display = 'none'; } if('zoom' in caps){ const min = typeof caps.zoom.min === 'number' ? caps.zoom.min : 1; const max = typeof caps.zoom.max === 'number' ? caps.zoom.max : 1; const step = typeof caps.zoom.step === 'number' ? caps.zoom.step : 0.1; const cur = typeof settingsV.zoom === 'number' ? settingsV.zoom : min; const slider = $('zoomSlider'); slider.min = String(min); slider.max = String(max); slider.step = String(step); slider.value = String(cur); $('zoomVal').textContent = (Number(slider.value)).toFixed(1) + '√ó'; $('cameraControls').style.display = 'flex'; slider.addEventListener('input', async (e)=>{ const v = Number(e.target.value); $('zoomVal').textContent = v.toFixed(1) + '√ó'; try{ await track.applyConstraints({ zoom: v }).catch(async ()=>{ await track.applyConstraints({ advanced:[{ zoom: v }] }); }); }catch(err){} }); }else{ $('cameraControls').style.display = 'none'; } }catch(e){ $('cameraControls').style.display = 'none'; } }

  function isAndroidIntentCapable(){ const ua = navigator.userAgent || ''; return /Android/i.test(ua) && /(Chrome|EdgA|Brave|SamsungBrowser|Chromium)/i.test(ua); }
  function tldFromKeepa(domainIdx){ const map = {1:'com',2:'co.uk',3:'de',4:'fr',5:'co.jp',6:'ca',7:'cn',8:'it',9:'es',10:'in',11:'com.mx',12:'com.br',13:'com.au',14:'nl',15:'se',16:'pl',17:'com.tr',18:'sg',19:'sa',20:'ae'}; return map[String(domainIdx||9)] || 'es'; }
  function openAmazonSmart(item){ try{ const webHref = item?.affiliateLink ? new URL(item.affiliateLink, location.origin).href : `https://www.amazon.${tldFromKeepa(item?.domain)}/dp/${encodeURIComponent(item?.asin || '')}`; if (settings.openInApp && isAndroidIntentCapable() && (item?.asin)){ const tld = tldFromKeepa(item?.domain); const asin = item.asin; const intentUrl = `intent://www.amazon.${tld}/dp/${encodeURIComponent(asin)}#Intent;scheme=https;package=com.amazon.mShop.android.shopping;S.browser_fallback_url=${encodeURIComponent(webHref)};end`; location.href = intentUrl; return; } location.href = webHref; }catch(e){} }

  function escapeHtml(s){ return String(s||'').replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }
  async function torchOff(){ try{ if(!stream) return; const track = stream.getVideoTracks()[0]; await track.applyConstraints({ advanced:[{ torch:false }] }); $('btnTorch').textContent = 'Linterna: OFF'; torchOn = false; }catch(e){} }

  /* ===== PWA: bot√≥n Instalar + registro autom√°tico de SW ===== */
  if ('serviceWorker' in navigator) { navigator.serviceWorker.register('/sw.js').catch(()=>{}); }
  let deferredPrompt = null;
  window.addEventListener('beforeinstallprompt', (e)=>{ e.preventDefault(); deferredPrompt = e; const installed = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone; if(!installed) $('btnInstall').style.display = 'inline-flex'; });
  window.addEventListener('appinstalled', ()=>{ $('btnInstall').style.display = 'none'; showToast({ message: '‚úÖ App instalada', type:'success' }); });
  $('btnInstall').addEventListener('click', async ()=>{ if(!deferredPrompt){ showToast({ message:'Instalaci√≥n no disponible en este navegador', type:'error' }); return; } deferredPrompt.prompt(); try{ await deferredPrompt.userChoice; }catch(_){} deferredPrompt = null; $('btnInstall').style.display = 'none'; });

  // iOS hint: mostrar ayuda para a√±adir a pantalla de inicio
  function showIOSHintIfNeeded(){
    const ua = window.navigator.userAgent || '';
    const isIOS = /iPad|iPhone|iPod/i.test(ua) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
    const inStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
    if(isIOS && !inStandalone){
      const el = $('iosHint'); if(el) el.style.display = 'block';
      const btn = $('btnInstall'); if(btn) btn.style.display = 'none';
    }
  }
  document.addEventListener('DOMContentLoaded', showIOSHintIfNeeded);

  </script>
</body>
</html>







